mutate(CCS = groupIcdToCCS(DxDataFile, ID, ICD, Date, icd10usingDate, isCCSDescription)) %>%
arrange(ID, CCS, Date) %>%
group_by(ID, CCS) %>%
mutate(Gap = Date - lag(Date))
}else if(icdorCCS == "ICD"){
DxDataFile <- DxDataFile %>%
arrange(ID, ICD, Date) %>%
group_by(ID, ICD) %>%
mutate(Gap = Date - lag(Date))
}else{
stop("'please enter icd or ccs for 'icdorCCS'", call. = FALSE)
}
DxDataFile$episode <- DxDataFile$Gap > gapDate
DxDataFile$episode[is.na(DxDataFile$episode)] <- TRUE
if(icdorCCS == "CCS"){
DxDataFile <- DxDataFile %>%
group_by(ID, CCS) %>%
mutate(Era = cumsum(episode))
}else if(icdorCCS == "ICD"){
DxDataFile <- DxDataFile %>%
group_by(ID, ICD) %>%
mutate(Era = cumsum(episode))
}
WrongFormat <- convertIcdDecimaltoShort(DxDataFile$ICD)$Error
if(length(WrongFormat) > 0 & icdorCCS == "ICD"){
message(paste0("wrong Format: ", unique(WrongFormat), sep = "\t\n"))
}
DxDataFile <- select(DxDataFile, c(-"Gap", -"episode"))
DxDataFile
}
getConditionEra(DxDataFile, ID, ICD, Date, "2016-01-01", 30, ccs, FALSE)
getConditionEra(DxDataFile, ID, ICD, Date, "2016-01-01", 30, ICD, FALSE)
#' @param icd10usingDate ICD-10 using date
#' @param isCCSCategoryDescription  Clinical Classifications Software (CCS) single level categories/ description for ICD-9 or ICD-10, default is True
#' @export
#' @examples
#' DxDataFile <- data.frame(ID=c("A","A","A"),
#'                          ICD=c("6929","V433","I350"),
#'                          Date=as.Date(c("2013-03-31","2013-01-29","2016-03-10")),
#'                          stringsAsFactors = FALSE)
#' groupIcdToCCS (DxDataFile, ID, ICD, Date, "2016-01-01", TRUE)
#'
groupIcdToCCS <- function(DxDataFile, idColName, icdColName, dateColName, icd10usingDate, isCCSCategoryDescription = TRUE){
DxDataFile <- DxDataFile[, c(deparse(substitute(idColName)), deparse(substitute(icdColName)), deparse(substitute(dateColName)))]
names(DxDataFile) <- c("ID", "ICD", "Date")
Format <- ifelse(any(grepl("[.]", DxDataFile$ICD)), "Decimal", "Short")
DxDataFile$ICD <- convertIcdDecimaltoShort(DxDataFile$ICD)$Short
icd10 <- DxDataFile[DxDataFile$Date >= icd10usingDate,] %>% unique()
icd9 <- DxDataFile[DxDataFile$Date < icd10usingDate,] %>% unique()
icd9ToCCS <- left_join(icd9, select(ccsDxICD9, ICD, CCS_CATEGORY, CCS_CATEGORY_DESCRIPTION), by = "ICD")
icd10ToCCS <- left_join(icd10, select(ccsDxICD10, ICD, CCS_CATEGORY, CCS_CATEGORY_DESCRIPTION), by = "ICD")
CCS_combine <- rbind(icd9ToCCS, icd10ToCCS)
CCS_combine_with_originalFile <- left_join(DxDataFile, CCS_combine, by = c("ID", "ICD", "Date"))
if (isCCSCategoryDescription == T) {
IcdToCCS <- CCS_combine_with_originalFile$CCS_CATEGORY_DESCRIPTION
} else {
IcdToCCS <- CCS_combine_with_originalFile$CCS_CATEGORY
}
WrongFormat <- convertIcdDecimaltoShort(DxDataFile$ICD)$Error
error_ICD <- anti_join(data.frame(ICD = CCS_combine_with_originalFile$ICD[is.na(IcdToCCS)], stringsAsFactors= FALSE),
data.frame(ICD = WrongFormat, stringsAsFactors= FALSE), "ICD") %>% unique
if(nrow(error_ICD) > 0){
if(length(WrongFormat) > 0){
message(paste0("wrong Format: ", unique(WrongFormat), sep = "\t\n"))
}
if(Format == "Decimal"){
message(paste0("warning ICD: ", convertIcdShortToDecimal(error_ICD$ICD)$Decimal, sep = "\t\n"))
}else{
message(paste0("warning ICD: ", error_ICD, sep = "\t\n"))
}
message("\n")
warning('The ICD mentioned above matches to "NA" due to the format or other issues.',call. = F)
warning('"wrong Format" means the ICD has wrong format',call. = F)
warning('"warning ICD" means the ICD classify to wrong ICD version (cause the "icd10usingDate" or other issues) ',call. = F)
}
IcdToCCS
}
groupIcdToCCS (DxDataFile, ID, ICD, Date, "2016-01-01", TRUE)
DxDataFile
Format <- ifelse(any(grepl("[.]", DxDataFile$ICD)), "Decimal", "Short")
DxDataFile$ICD <- convertIcdDecimaltoShort(DxDataFile$ICD)$Short
icd10 <- DxDataFile[DxDataFile$Date >= icd10usingDate,] %>% unique()
icd9 <- DxDataFile[DxDataFile$Date < icd10usingDate,] %>% unique()
icd9ToCCS <- left_join(icd9, select(ccsDxICD9, ICD, CCS_CATEGORY, CCS_CATEGORY_DESCRIPTION), by = "ICD")
icd10ToCCS <- left_join(icd10, select(ccsDxICD10, ICD, CCS_CATEGORY, CCS_CATEGORY_DESCRIPTION), by = "ICD")
CCS_combine <- rbind(icd9ToCCS, icd10ToCCS)
CCS_combine_with_originalFile <- left_join(DxDataFile, CCS_combine, by = c("ID", "ICD", "Date"))
IcdToCCS <- CCS_combine_with_originalFile$CCS_CATEGORY
WrongFormat <- convertIcdDecimaltoShort(DxDataFile$ICD)$Error
error_ICD <- anti_join(data.frame(ICD = CCS_combine_with_originalFile$ICD[is.na(IcdToCCS)], stringsAsFactors= FALSE),
data.frame(ICD = WrongFormat, stringsAsFactors= FALSE), "ICD") %>% unique
error_ICD
CCS_combine_with_originalFile
CCS_combine_with_originalFile$ICD[is.na(IcdToCCS)]
is.na(IcdToCCS)
#' @param icd10usingDate ICD-10 using date
#' @param isCCSCategoryDescription  Clinical Classifications Software (CCS) single level categories/ description for ICD-9 or ICD-10, default is True
#' @export
#' @examples
#' DxDataFile <- data.frame(ID=c("A","A","A"),
#'                          ICD=c("6929","V433","I350"),
#'                          Date=as.Date(c("2013-03-31","2013-01-29","2016-03-10")),
#'                          stringsAsFactors = FALSE)
#' groupIcdToCCS (DxDataFile, ID, ICD, Date, "2016-01-01", TRUE)
#'
groupIcdToCCS <- function(DxDataFile, idColName, icdColName, dateColName, icd10usingDate, isCCSCategoryDescription = TRUE){
DxDataFile <- DxDataFile[, c(deparse(substitute(idColName)), deparse(substitute(icdColName)), deparse(substitute(dateColName)))]
names(DxDataFile) <- c("ID", "ICD", "Date")
Format <- ifelse(any(grepl("[.]", DxDataFile$ICD)), "Decimal", "Short")
DxDataFile$ICD <- convertIcdDecimaltoShort(DxDataFile$ICD)$Short
icd10 <- DxDataFile[DxDataFile$Date >= icd10usingDate,] %>% unique()
icd9 <- DxDataFile[DxDataFile$Date < icd10usingDate,] %>% unique()
icd9ToCCS <- left_join(icd9, select(ccsDxICD9, ICD, CCS_CATEGORY, CCS_CATEGORY_DESCRIPTION), by = "ICD")
icd10ToCCS <- left_join(icd10, select(ccsDxICD10, ICD, CCS_CATEGORY, CCS_CATEGORY_DESCRIPTION), by = "ICD")
CCS_combine <- rbind(icd9ToCCS, icd10ToCCS)
CCS_combine_with_originalFile <- left_join(DxDataFile, CCS_combine, by = c("ID", "ICD", "Date"))
if (isCCSCategoryDescription == T) {
IcdToCCS <- CCS_combine_with_originalFile$CCS_CATEGORY_DESCRIPTION
} else {
IcdToCCS <- CCS_combine_with_originalFile$CCS_CATEGORY
}
WrongFormat <- convertIcdDecimaltoShort(DxDataFile$ICD)$Error
error_ICD <- anti_join(data.frame(ICD = CCS_combine_with_originalFile$ICD[is.na(IcdToCCS)], stringsAsFactors= FALSE),
data.frame(ICD = WrongFormat, stringsAsFactors= FALSE), "ICD") %>% unique
if(length(is.na(IcdToCCS)) > 0){
if(length(WrongFormat) > 0){
message(paste0("wrong Format: ", unique(WrongFormat), sep = "\t\n"))
}
if(Format == "Decimal"){
message(paste0("warning ICD: ", convertIcdShortToDecimal(error_ICD$ICD)$Decimal, sep = "\t\n"))
}else{
message(paste0("warning ICD: ", error_ICD, sep = "\t\n"))
}
message("\n")
warning('The ICD mentioned above matches to "NA" due to the format or other issues.',call. = F)
warning('"wrong Format" means the ICD has wrong format',call. = F)
warning('"warning ICD" means the ICD classify to wrong ICD version (cause the "icd10usingDate" or other issues) ',call. = F)
}
IcdToCCS
}
groupIcdToCCS (DxDataFile, ID, ICD, Date, "2016-01-01", TRUE)
length(is.na(IcdToCCS)) > length(WrongFormat)
#' @param icd10usingDate ICD-10 using date
#' @param isCCSCategoryDescription  Clinical Classifications Software (CCS) single level categories/ description for ICD-9 or ICD-10, default is True
#' @export
#' @examples
#' DxDataFile <- data.frame(ID=c("A","A","A"),
#'                          ICD=c("6929","V433","I350"),
#'                          Date=as.Date(c("2013-03-31","2013-01-29","2016-03-10")),
#'                          stringsAsFactors = FALSE)
#' groupIcdToCCS (DxDataFile, ID, ICD, Date, "2016-01-01", TRUE)
#'
groupIcdToCCS <- function(DxDataFile, idColName, icdColName, dateColName, icd10usingDate, isCCSCategoryDescription = TRUE){
DxDataFile <- DxDataFile[, c(deparse(substitute(idColName)), deparse(substitute(icdColName)), deparse(substitute(dateColName)))]
names(DxDataFile) <- c("ID", "ICD", "Date")
Format <- ifelse(any(grepl("[.]", DxDataFile$ICD)), "Decimal", "Short")
DxDataFile$ICD <- convertIcdDecimaltoShort(DxDataFile$ICD)$Short
icd10 <- DxDataFile[DxDataFile$Date >= icd10usingDate,] %>% unique()
icd9 <- DxDataFile[DxDataFile$Date < icd10usingDate,] %>% unique()
icd9ToCCS <- left_join(icd9, select(ccsDxICD9, ICD, CCS_CATEGORY, CCS_CATEGORY_DESCRIPTION), by = "ICD")
icd10ToCCS <- left_join(icd10, select(ccsDxICD10, ICD, CCS_CATEGORY, CCS_CATEGORY_DESCRIPTION), by = "ICD")
CCS_combine <- rbind(icd9ToCCS, icd10ToCCS)
CCS_combine_with_originalFile <- left_join(DxDataFile, CCS_combine, by = c("ID", "ICD", "Date"))
if (isCCSCategoryDescription == T) {
IcdToCCS <- CCS_combine_with_originalFile$CCS_CATEGORY_DESCRIPTION
} else {
IcdToCCS <- CCS_combine_with_originalFile$CCS_CATEGORY
}
WrongFormat <- convertIcdDecimaltoShort(DxDataFile$ICD)$Error
error_ICD <- anti_join(data.frame(ICD = CCS_combine_with_originalFile$ICD[is.na(IcdToCCS)], stringsAsFactors= FALSE),
data.frame(ICD = WrongFormat, stringsAsFactors= FALSE), "ICD") %>% unique
if(length(is.na(IcdToCCS)) > 0){
if(length(WrongFormat) > 0){
message(paste0("wrong Format: ", unique(WrongFormat), sep = "\t\n"))
}
if(length(is.na(IcdToCCS)) > length(WrongFormat)){
if(Format == "Decimal"){
message(paste0("warning ICD: ", convertIcdShortToDecimal(error_ICD$ICD)$Decimal, sep = "\t\n"))
}else{
message(paste0("warning ICD: ", error_ICD, sep = "\t\n"))
}
}
message("\n")
warning('The ICD mentioned above matches to "NA" due to the format or other issues.',call. = F)
warning('"wrong Format" means the ICD has wrong format',call. = F)
warning('"warning ICD" means the ICD classify to wrong ICD version (cause the "icd10usingDate" or other issues) ',call. = F)
}
IcdToCCS
}
groupIcdToCCS (DxDataFile, ID, ICD, Date, "2016-01-01", TRUE)
#' @param icd10usingDate ICD-10 using date
#' @param isCCSCategoryDescription  Clinical Classifications Software (CCS) single level categories/ description for ICD-9 or ICD-10, default is True
#' @export
#' @examples
#' DxDataFile <- data.frame(ID=c("A","A","A"),
#'                          ICD=c("6929","V433","I350"),
#'                          Date=as.Date(c("2013-03-31","2013-01-29","2016-03-10")),
#'                          stringsAsFactors = FALSE)
#' groupIcdToCCS (DxDataFile, ID, ICD, Date, "2016-01-01", TRUE)
#'
groupIcdToCCS <- function(DxDataFile, idColName, icdColName, dateColName, icd10usingDate, isCCSCategoryDescription = TRUE){
DxDataFile <- DxDataFile[, c(deparse(substitute(idColName)), deparse(substitute(icdColName)), deparse(substitute(dateColName)))]
names(DxDataFile) <- c("ID", "ICD", "Date")
Format <- ifelse(any(grepl("[.]", DxDataFile$ICD)), "Decimal", "Short")
DxDataFile$ICD <- convertIcdDecimaltoShort(DxDataFile$ICD)$Short
icd10 <- DxDataFile[DxDataFile$Date >= icd10usingDate,] %>% unique()
icd9 <- DxDataFile[DxDataFile$Date < icd10usingDate,] %>% unique()
icd9ToCCS <- left_join(icd9, select(ccsDxICD9, ICD, CCS_CATEGORY, CCS_CATEGORY_DESCRIPTION), by = "ICD")
icd10ToCCS <- left_join(icd10, select(ccsDxICD10, ICD, CCS_CATEGORY, CCS_CATEGORY_DESCRIPTION), by = "ICD")
CCS_combine <- rbind(icd9ToCCS, icd10ToCCS)
CCS_combine_with_originalFile <- left_join(DxDataFile, CCS_combine, by = c("ID", "ICD", "Date"))
if (isCCSCategoryDescription == T) {
IcdToCCS <- CCS_combine_with_originalFile$CCS_CATEGORY_DESCRIPTION
} else {
IcdToCCS <- CCS_combine_with_originalFile$CCS_CATEGORY
}
WrongFormat <- convertIcdDecimaltoShort(DxDataFile$ICD)$Error
error_ICD <- anti_join(data.frame(ICD = CCS_combine_with_originalFile$ICD[is.na(IcdToCCS)], stringsAsFactors= FALSE),
data.frame(ICD = WrongFormat, stringsAsFactors= FALSE), "ICD") %>% unique
if(length(is.na(IcdToCCS)) > 0){
if(length(WrongFormat) > 0){
message(paste0("wrong Format: ", unique(WrongFormat), sep = "\t\n"))
}
if(length(is.na(IcdToCCS)) > length(WrongFormat)){
if(Format == "Decimal"){
message(paste0("warning ICD: ", convertIcdShortToDecimal(error_ICD$ICD)$Decimal, sep = "\t\n"))
}else{
message(paste0("warning ICD: ", error_ICD, sep = "\t\n"))
}
}
message("\n")
warning('The ICD mentioned above matches to "NA" due to the format or other issues.',call. = F)
warning('"wrong Format" means the ICD has wrong format',call. = F)
warning('"warning ICD" means the ICD classify to wrong ICD version (cause the "icd10usingDate" or other issues) ',call. = F)
}
IcdToCCS
}
groupIcdToCCS (DxDataFile, ID, ICD, Date, "2016-01-01", TRUE)
length(is.na(IcdToCCS))
is.na(IcdToCCS)
sum(is.na(IcdToCCS))
length(WrongFormat)
#' @param icd10usingDate ICD-10 using date
#' @param isCCSCategoryDescription  Clinical Classifications Software (CCS) single level categories/ description for ICD-9 or ICD-10, default is True
#' @export
#' @examples
#' DxDataFile <- data.frame(ID=c("A","A","A"),
#'                          ICD=c("6929","V433","I350"),
#'                          Date=as.Date(c("2013-03-31","2013-01-29","2016-03-10")),
#'                          stringsAsFactors = FALSE)
#' groupIcdToCCS (DxDataFile, ID, ICD, Date, "2016-01-01", TRUE)
#'
groupIcdToCCS <- function(DxDataFile, idColName, icdColName, dateColName, icd10usingDate, isCCSCategoryDescription = TRUE){
DxDataFile <- DxDataFile[, c(deparse(substitute(idColName)), deparse(substitute(icdColName)), deparse(substitute(dateColName)))]
names(DxDataFile) <- c("ID", "ICD", "Date")
Format <- ifelse(any(grepl("[.]", DxDataFile$ICD)), "Decimal", "Short")
DxDataFile$ICD <- convertIcdDecimaltoShort(DxDataFile$ICD)$Short
icd10 <- DxDataFile[DxDataFile$Date >= icd10usingDate,] %>% unique()
icd9 <- DxDataFile[DxDataFile$Date < icd10usingDate,] %>% unique()
icd9ToCCS <- left_join(icd9, select(ccsDxICD9, ICD, CCS_CATEGORY, CCS_CATEGORY_DESCRIPTION), by = "ICD")
icd10ToCCS <- left_join(icd10, select(ccsDxICD10, ICD, CCS_CATEGORY, CCS_CATEGORY_DESCRIPTION), by = "ICD")
CCS_combine <- rbind(icd9ToCCS, icd10ToCCS)
CCS_combine_with_originalFile <- left_join(DxDataFile, CCS_combine, by = c("ID", "ICD", "Date"))
if (isCCSCategoryDescription == T) {
IcdToCCS <- CCS_combine_with_originalFile$CCS_CATEGORY_DESCRIPTION
} else {
IcdToCCS <- CCS_combine_with_originalFile$CCS_CATEGORY
}
WrongFormat <- convertIcdDecimaltoShort(DxDataFile$ICD)$Error
error_ICD <- anti_join(data.frame(ICD = CCS_combine_with_originalFile$ICD[is.na(IcdToCCS)], stringsAsFactors= FALSE),
data.frame(ICD = WrongFormat, stringsAsFactors= FALSE), "ICD") %>% unique
if(length(is.na(IcdToCCS)) > 0){
if(length(WrongFormat) > 0){
message(paste0("wrong Format: ", unique(WrongFormat), sep = "\t\n"))
}
if(sum(is.na(IcdToCCS)) > length(WrongFormat)){
if(Format == "Decimal"){
message(paste0("warning ICD: ", convertIcdShortToDecimal(error_ICD$ICD)$Decimal, sep = "\t\n"))
}else{
message(paste0("warning ICD: ", error_ICD, sep = "\t\n"))
}
}
message("\n")
warning('The ICD mentioned above matches to "NA" due to the format or other issues.',call. = F)
warning('"wrong Format" means the ICD has wrong format',call. = F)
warning('"warning ICD" means the ICD classify to wrong ICD version (cause the "icd10usingDate" or other issues) ',call. = F)
}
IcdToCCS
}
groupIcdToCCS (DxDataFile, ID, ICD, Date, "2016-01-01", TRUE)
#' @param icd10usingDate ICD-10 using date
#' @param isCCSCategoryDescription  Clinical Classifications Software (CCS) single level categories/ description for ICD-9 or ICD-10, default is True
#' @export
#' @examples
#' DxDataFile <- data.frame(ID=c("A","A","A"),
#'                          ICD=c("6929","V433","I350"),
#'                          Date=as.Date(c("2013-03-31","2013-01-29","2016-03-10")),
#'                          stringsAsFactors = FALSE)
#' groupIcdToCCS (DxDataFile, ID, ICD, Date, "2016-01-01", TRUE)
#'
groupIcdToCCS <- function(DxDataFile, idColName, icdColName, dateColName, icd10usingDate, isCCSCategoryDescription = TRUE){
DxDataFile <- DxDataFile[, c(deparse(substitute(idColName)), deparse(substitute(icdColName)), deparse(substitute(dateColName)))]
names(DxDataFile) <- c("ID", "ICD", "Date")
Format <- ifelse(any(grepl("[.]", DxDataFile$ICD)), "Decimal", "Short")
DxDataFile$ICD <- convertIcdDecimaltoShort(DxDataFile$ICD)$Short
icd10 <- DxDataFile[DxDataFile$Date >= icd10usingDate,] %>% unique()
icd9 <- DxDataFile[DxDataFile$Date < icd10usingDate,] %>% unique()
icd9ToCCS <- left_join(icd9, select(ccsDxICD9, ICD, CCS_CATEGORY, CCS_CATEGORY_DESCRIPTION), by = "ICD")
icd10ToCCS <- left_join(icd10, select(ccsDxICD10, ICD, CCS_CATEGORY, CCS_CATEGORY_DESCRIPTION), by = "ICD")
CCS_combine <- rbind(icd9ToCCS, icd10ToCCS)
CCS_combine_with_originalFile <- left_join(DxDataFile, CCS_combine, by = c("ID", "ICD", "Date"))
if (isCCSCategoryDescription == T) {
IcdToCCS <- CCS_combine_with_originalFile$CCS_CATEGORY_DESCRIPTION
} else {
IcdToCCS <- CCS_combine_with_originalFile$CCS_CATEGORY
}
WrongFormat <- convertIcdDecimaltoShort(DxDataFile$ICD)$Error
error_ICD <- anti_join(data.frame(ICD = CCS_combine_with_originalFile$ICD[is.na(IcdToCCS)], stringsAsFactors= FALSE),
data.frame(ICD = WrongFormat, stringsAsFactors= FALSE), "ICD") %>% unique
if(length(is.na(IcdToCCS)) > 0){
if(length(WrongFormat) > 0){
message(paste0("wrong Format: ", unique(WrongFormat), sep = "\t\n"))
}
if(sum(is.na(IcdToCCS)) > length(WrongFormat)){
if(Format == "Decimal"){
message(paste0("warning ICD: ", convertIcdShortToDecimal(error_ICD$ICD)$Decimal, sep = "\t\n"))
}else{
message(paste0("warning ICD: ", error_ICD, sep = "\t\n"))
}
message("\n")
}
warning('The ICD mentioned above matches to "NA" due to the format or other issues.',call. = F)
warning('"wrong Format" means the ICD has wrong format',call. = F)
warning('"warning ICD" means the ICD classify to wrong ICD version (cause the "icd10usingDate" or other issues) ',call. = F)
}
IcdToCCS
}
groupIcdToCCS (DxDataFile, ID, ICD, Date, "2016-01-01", TRUE)
#' @param isCCSDescription  Clinical Classifications Software (CCS) single level categories (False) and description (True) for ICD-9 or ICD-10, default is False.
#' @export
#' @examples
#' DxDataFile <- data.frame(ID=c("A","A","A"),
#'                          ICD=c("6929","V433","I350"),
#'                          Date=as.Date(c("2013-03-31","2013-01-29","2016-03-10")),
#'                          stringsAsFactors = FALSE)
#' getConditionEra(DxDataFile, ID, ICD, Date, "2016-01-01", 30, ccs, FALSE)
#' getConditionEra(DxDataFile, ID, ICD, Date, "2016-01-01", 30, ICD, FALSE)
#'
getConditionEra <- function(DxDataFile, idColName, icdColName, dateColName, icd10usingDate, gapDate = 30, icdorCCS = CCS, isCCSDescription = FALSE){
DxDataFile <- DxDataFile[ ,c(deparse(substitute(idColName)), deparse(substitute(icdColName)), deparse(substitute(dateColName)))]
names(DxDataFile) <- c("ID", "ICD", "Date")
DxDataFile$ICD <- convertIcdDecimaltoShort(DxDataFile$ICD)$Short
icd10 <- DxDataFile[DxDataFile$Date >= icd10usingDate,]
icd9 <- DxDataFile[DxDataFile$Date < icd10usingDate,]
icdorCCS <- toupper(deparse(substitute(icdorCCS)))
if(icdorCCS == "CCS"){
DxDataFile <- DxDataFile %>%
mutate(CCS = groupIcdToCCS(DxDataFile, ID, ICD, Date, icd10usingDate, isCCSDescription)) %>%
arrange(ID, CCS, Date) %>%
group_by(ID, CCS) %>%
mutate(Gap = Date - lag(Date))
}else if(icdorCCS == "ICD"){
DxDataFile <- DxDataFile %>%
arrange(ID, ICD, Date) %>%
group_by(ID, ICD) %>%
mutate(Gap = Date - lag(Date))
}else{
stop("'please enter icd or ccs for 'icdorCCS'", call. = FALSE)
}
DxDataFile$episode <- DxDataFile$Gap > gapDate
DxDataFile$episode[is.na(DxDataFile$episode)] <- TRUE
if(icdorCCS == "CCS"){
DxDataFile <- DxDataFile %>%
group_by(ID, CCS) %>%
mutate(Era = cumsum(episode))
}else if(icdorCCS == "ICD"){
DxDataFile <- DxDataFile %>%
group_by(ID, ICD) %>%
mutate(Era = cumsum(episode))
}
WrongFormat <- convertIcdDecimaltoShort(DxDataFile$ICD)$Error
if(length(WrongFormat) > 0 & icdorCCS == "ICD"){
message(paste0("wrong Format: ", unique(WrongFormat), sep = "\t\n"))
}
DxDataFile <- select(DxDataFile, c(-"Gap", -"episode"))
DxDataFile
}
getConditionEra(DxDataFile, ID, ICD, Date, "2016-01-01", 30, ccs, FALSE)
getConditionEra(DxDataFile, ID, ICD, Date, "2016-01-01", 30, ICD, FALSE)
#' @param CCSLevel Clinical Classifications Software (CCS) multiple level
#' @param CCSLvlLabel Clinical Classifications Software (CCS) multiple level categories/ description for icd9/ 10, default is True
#' @export
#' @examples
#' DxDataFile <- data.frame(ID=c("A","A","A"),
#'                          ICD=c("6929","V433","I350"),
#'                          Date=as.Date(c("2013-03-31","2013-01-29","2016-03-10")),
#'                          stringsAsFactors = FALSE)
#' groupIcdToCCSLvl(DxDataFile, ID, ICD, Date, "2016-01-01", 2, TRUE)
#'
groupIcdToCCSLvl <- function(DxDataFile, idColName, icdColName, dateColName, icd10usingDate, CCSLevel = 1, CCSLvlLabel = TRUE){
DxDataFile <- DxDataFile[ , c(deparse(substitute(idColName)), deparse(substitute(icdColName)), deparse(substitute(dateColName)))]
names(DxDataFile) <- c("ID", "ICD", "Date")
DxDataFile$ICD <- convertIcdDecimaltoShort(DxDataFile$ICD)$Short
icd9 <- DxDataFile[DxDataFile$Date < icd10usingDate,]
icd10 <- DxDataFile[DxDataFile$Date >= icd10usingDate,]
if(nrow(icd10) < 0){
icd9ToCCSLvl <- left_join(icd9, select(ccsDxICD9, ICD, CCS_LVL_1, CCS_LVL_1_LABEL, CCS_LVL_2, CCS_LVL_2_LABEL,
CCS_LVL_3, CCS_LVL_3_LABEL, CCS_LVL_4, CCS_LVL_4_LABEL), by = "ICD") %>% unique()
DxDataFile_combine <- icd9ToCCSLvl
}else if(nrow(icd9) < 0){
icd10ToCCSLvl <- left_join(icd10, select(ccsDxICD10, ICD, CCS_LVL_1, CCS_LVL_1_LABEL, CCS_LVL_2, CCS_LVL_2_LABEL), by = "ICD") %>% unique()
DxDataFile_combine <- icd10ToCCSLvl
}else if(nrow(icd9) >= 0 & nrow(icd10) >= 0){
icd9ToCCSLvl <- left_join(icd9, select(ccsDxICD9, ICD, CCS_LVL_1, CCS_LVL_1_LABEL, CCS_LVL_2, CCS_LVL_2_LABEL,
CCS_LVL_3, CCS_LVL_3_LABEL, CCS_LVL_4, CCS_LVL_4_LABEL), by = "ICD") %>% unique()
icd10ToCCSLvl <- left_join(icd10, select(ccsDxICD10, ICD, CCS_LVL_1, CCS_LVL_1_LABEL, CCS_LVL_2, CCS_LVL_2_LABEL),
by = "ICD") %>% unique()
DxDataFile_combine <- full_join(icd9ToCCSLvl, icd10ToCCSLvl, by = c("ID", "ICD", "Date", "CCS_LVL_1", "CCS_LVL_1_LABEL", "CCS_LVL_2", "CCS_LVL_2_LABEL"))
}
DxDataFile_combine_with_originalFile <- left_join(DxDataFile,DxDataFile_combine, by = c("ID", "ICD", "Date"))
if(CCSLvlLabel == T){
CCSLevelcol <- as.character(parse(text = paste("CCS_LVL_", CCSLevel, "_LABEL", sep = "")))
}else{
CCSLevelcol <- as.character(parse(text = paste("CCS_LVL_", CCSLevel, sep = "")))
}
IcdToCCSLevel <- DxDataFile_combine_with_originalFile[, CCSLevelcol]
if(anyNA(IcdToCCSLevel)){
message(paste0("warning ICD: ", unique(DxDataFile_combine_with_originalFile$ICD[is.na(IcdToCCSLevel)]), sep = "\t\n"))
warning("'NA' means icd10 CCS multiple levels are 1~2 or the data does not match the format", call. = F)
}
IcdToCCSLevel
}
groupIcdToCCSLvl(DxDataFile, ID, ICD, Date, "2016-01-01", 2, TRUE)
#' @examples
#' DxDataFile <- data.frame(ID=c("A","A","B","B"),
#'                          ICD=c("40201","42577","I350","K289"),
#'                          Date=as.Date(c("2013-03-31","2013-01-29","2016-03-10","2016-03-10")),
#'                          stringsAsFactors = FALSE)
#'
#' groupIcdToComorbid(DxDataFile, ID, ICD, Date, "2016-01-01", ahrq, N, TRUE)
#' groupIcdToComorbid(DxDataFile, ID, ICD, Date, "2016-01-01", charlson, B, TRUE)
#' groupIcdToComorbid(DxDataFile, ID, ICD, Date, "2016-01-01", elix, N, TRUE)
#'
groupIcdToComorbid <- function(DxDataFile, idColName, icdColName, dateColName, icd10usingDate, comorbidMethod, NumericOrBinary = B, groupByDate = TRUE){
comorbidMap9 <- `icd9_ahrq`
comorbidMap10 <- `icd10_ahrq`
groupIcdToComorbid(DxDataFile, ID, ICD, Date, "2016-01-01", ahrq, N, TRUE)
load("~/emr/data/phecode_icd9_2.rda")
#' @examples
#' DxDataFile <- data.frame(ID=c("A","A","B","B"),
#'                          ICD=c("40201","42577","I350","K289"),
#'                          Date=as.Date(c("2013-03-31","2013-01-29","2016-03-10","2016-03-10")),
#'                          stringsAsFactors = FALSE)
#'
#' groupIcdToComorbid(DxDataFile, ID, ICD, Date, "2016-01-01", ahrq, N, TRUE)
#' groupIcdToComorbid(DxDataFile, ID, ICD, Date, "2016-01-01", charlson, B, TRUE)
#' groupIcdToComorbid(DxDataFile, ID, ICD, Date, "2016-01-01", elix, N, TRUE)
#'
groupIcdToComorbid <- function(DxDataFile, idColName, icdColName, dateColName, icd10usingDate, comorbidMethod, NumericOrBinary = B, groupByDate = TRUE){
DxDataFile <- DxDataFile[ , c(deparse(substitute(idColName)), deparse(substitute(icdColName)), deparse(substitute(dateColName)))]
names(DxDataFile) <- c("ID", "ICD", "Date")
DxDataFile$ICD <- convertIcdDecimaltoShort(DxDataFile$ICD)$Short
comorbidMethod <- tolower(deparse(substitute(comorbidMethod)))
if (grepl("ahrq", comorbidMethod)){
comorbidMap9 <- `icd9_ahrq`
comorbidMap10 <- `icd10_ahrq`
}else if(grepl("charlson", comorbidMethod)){
comorbidMap9 <- `icd9_charlson`
comorbidMap10 <- `icd10_charlson`
}else if(grepl("elix", comorbidMethod)){
comorbidMap9 <- `icd9_elix`
comorbidMap10 <- `icd10_elix`
}
icd9 <- data.frame(DxDataFile[DxDataFile$Date < icd10usingDate,])
icd10 <- data.frame(DxDataFile[DxDataFile$Date >= icd10usingDate,])
if(nrow(icd9) <= 0){
comorbidDf10 <- left_join(icd10, comorbidMap10, by = "ICD")
comorbidDf_combine <- comorbidDf10
}else if(nrow(icd10) <= 0){
comorbidDf9 <- left_join(icd9, comorbidMap9,by = "ICD")
comorbidDf_combine <- comorbidDf9
}else if(nrow(icd9) > 0 & nrow(icd10) > 0){
comorbidDf9 <- left_join(icd9, comorbidMap9,by = "ICD")
comorbidDf10 <- left_join(icd10, comorbidMap10, by = "ICD")
comorbidDf_combine <- rbind(comorbidDf9, comorbidDf10, by = c(names(comorbidMap10)))#, "ID", "ICD", "Date", "Comorbidity", "Value"))
}
comorbidDf_combine$ICD <- NULL
if(groupByDate ==T){
comorbidDf_combine <- comorbidDf_combine %>% group_by(ID, Date, Comorbidity) %>% unique()
}
comorbidDf_combine_wide <- dcast(comorbidDf_combine, ID~Comorbidity, value.var = c("Value"), sum)
all_comorbidity_measures <- data.frame(matrix(nrow = length(comorbidDf_combine_wide$ID), ncol = length(unique(comorbidMap9$Comorbidity))))
names(all_comorbidity_measures) <- unique(comorbidMap9$Comorbidity)
all_comorbidity_measures <- mutate(all_comorbidity_measures, ID = comorbidDf_combine_wide$ID)
JoiningBycol <- names(comorbidDf_combine_wide[ names(comorbidDf_combine_wide) != "NA"])
combine <- right_join(all_comorbidity_measures, comorbidDf_combine_wide,by = JoiningBycol)
combine <- combine[, names(combine) != "NA"]
combine_Numeric <- combine[, c(ncol(combine), 1:(ncol(combine)-1))]
combine_Numeric[is.na(combine_Numeric)] <- 0L
if(toupper(deparse(substitute(NumericOrBinary))) == "B"){
combine_Binary <-as.data.frame(combine_Numeric >= 1L)
combine_Binary$ID <- unique(DxDataFile$ID)
return(combine_Binary)
}else if(toupper(deparse(substitute(NumericOrBinary))) == "N"){
return(combine_Numeric)
}else{
stop("'please enter N or B for 'comorbidMethod'", call. = FALSE)
}
}
load("~/emr/data/icd10_ahrq.rda")
load("~/emr/data/icd9_ahrq.rda")
groupIcdToComorbid(DxDataFile, ID, ICD, Date, "2016-01-01", ahrq, N, TRUE)
