---
title: "Getting started with dxpr: Diagnosis"
author: "Hsiang-Ju, Chiu"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Intro: Dx}
  %\VignetteEngine{knitr::rmarkdown}
  %\usepackage{UTF-8}{inputenc}
---

# Description
```
cat(utils::packageDescription("dxpr")$Description)
```
### Development version
```r
install.packages("devtools")
# Install development version from GitHub
devtools::install_github("DHLab-TSENG/dxpr")
library(dxpr)
```
```{r setup, echo = FALSE, message = FALSE}
knitr::opts_chunk$set(collapse = T, comment = "#>")
options(tibble.print_min = 4L, tibble.print_max = 4L)
devtools::install_github("DHLab-TSENG/dxpr")
library(dxpr)
```
### ICD-CM code with two format 
dxpr package uses ICD-CM codes as diagnosis standard. There are two formats of ICD-9 and ICD-10 codes, decimal (with a decimal place separating the code) and short format, respectively. So two tables of ICD-9-CM and ICD-10-CM are generated: \code{ICD9DxwithTwoFormat} and \code{ICD10DxwithTwoFormat}.


ICD-9-CM
```{r}
# Short
head(ICD9DxwithTwoFormat$Short)
# Decimal
head(ICD9DxwithTwoFormat$Decimal)
```
ICD-10-CM
```{r}
# Short
head(ICD10DxwithTwoFormat$Short)
# Decimal
head(ICD10DxwithTwoFormat$Decimal)
```

### Sample file
A sample file is included in dxpr package:  
This dataset is a simulated medical dataset of 38 patients with overall 300 records. 
```{r}
head(sampleDxFile)
```
## I.Code Integration

The input data should be in data frame format.

```r
con <- DBI::dbConnect(odbc::odbc(),
                      Driver   = "[your driver's name]",
                      Server   = "[your server's path]",
                      Database = "[your database's name]",
                      UID      = "[Database user]",
                      PWD      = "[Database password]")
dxDataFile <- dbSendQuery(con, "SELECT * FROM example_table WHERE ID = 'sampleID'")
dbFetch(dxDataFile)
```

In the R ecosystem, DBI, odbc, and other packages provide access to databases within R. As long as the data is retrieved from databases to a data frame in R, the following processes are the same as the example.

### A. ICD diagnostic code format transformation：Short <-> Decimal

dxpr package helps users to standardize the ICD-9 and ICD-10 diagnostic codes into a uniform format before further code grouping. The formats used for different grouping methods are shown as **Table 1**.

**Table 1** Format of code classification methods 

|   |ICD format|
|--------|----|
|Clinical Classifications Software (CCS)|short format|
|Comorbidity |short format|
|Phenome-Wide Association Studies(PheWAS)|decimal format|

Since formats of ICD code used in datasets could be different, the transformational type is according to the grouping method chosen by users. 

For example, if a user wants to group data by CCS,  then ICD codes should be transformed into **short** format.

Code standardization for ICD-9 and ICD-10 is executed seperately, there are two ways to distinguish the version of ICD diagnostic code (ICD-9/ICD-10) used in data: one is a specific column that records version used (numeric \code{9} or \code{10}), the other is to set the starting using date of ICD-10. For example, reimbursement claims with a date required to use of ICD-10 codes in United States and Taiwan are October 1st, 2015 and January 1st, 2016, respectively.

#### A-1. Uniform decimal format

The standardization function converts the ICD diagnostic codes to a uniform decimal format, which can be used for grouping diagnostic code to PheWAS classification.

```{r, message = FALSE, warning = FALSE}
# Short to decimal
decimal <- icdDxShortToDecimal(dxDataFile = sampleDxFile,
                               icdColName = ICD, 
                               dateColName = Date,
                               icd10usingDate = "2015/10/01")
decimal$ICD[6:10]
```

In this example, the starting using date of ICD-10 is "2015/10/01".

#### A-2. Uniform short format

`icdDxDecimalToShort` function converts the diagnostic codes to the short format, which can be used for grouping to CCS and comorbidities classification. 

```{r, message = FALSE, warning = FALSE}
# Decimal to short
short <- icdDxDecimalToShort(dxDataFile = sampleDxFile,
                            icdColName = ICD,         
                            dateColName = Date,
                            icd10usingDate = "2015/10/01")
short$ICD[6:10]
```

**Warning message**

Through code standardization functions generate data of diagnosis codes with potential error, to help a researcher identify the potential coding mistake that may affect clinical data analysis.

Error type：**wrong format** and **wrong version**
```{r, message = FALSE, warning = FALSE}
sample <- icdDxShortToDecimal(dxDataFile = sampleDxFile,
                              icdColName = ICD, 
                              dateColName = Date,
                              icd10usingDate = "2015/10/01")
```
1) Wrong ICD format: total 9 ICD codes (the number of occurrences is in brackets)

    c("A0.11 (20)", "E114 (8)", "Z9.90 (6)", "F42 (6)", "001 (5)", "75.52 (4)", "755.2 (3)", "123.45 (3)", "7552 (2)")

2) Wrong ICD version: total 7 ICD codes (the number of occurrences is in brackets)

    c("V27.0 (18)", "A01.05 (8)", "42761 (7)", "V24.1 (6)", "A0105 (5)", "E03.0 (4)", "650 (4)")
    
`sample$Error` shows individual error ICD codes in descending order.
```{r}
sample$Error
```
The dxpr package also provides an overview of error ICD data by Pareto chart (`plotICDError`).

**Workflow of warning message**

The example of warning messages are shown as below by `icdDxShortToDecimal`.

<img src="https://raw.githubusercontent.com/DHLab-TSENG/dhlab-cgu.github.io/master/dxpr/warning.jpg" style="display:block; margin:auto; width:100%;">

* Separate ICD-9 and ICD-10 by `icd10usingdate`
* Step 1: Separate short and decimal
* Step 2: The first time convert and confirm  
Group short: **first** transformat into decimal format  
> ICD-9: C, E  
> ICD-10: A  
Group decimal: **first** transformat with correct decimal format  
> ICD-9: D  
> ICD-10: B  
* Step 3: The second time convert and confirm with patients who has NA (A, C, D, E)  
> A has ICD-10 code, the second time convert and confirm with `ICD9DxwithTwoFormat`  
> C, D, E have ICD-9 code, the second time convert and confirm with `ICD10DxwithTwoFormat`  
Result:     
Both A,C are  **wrong version** (*42761* is ICD 9 diagnostic code and *A0105* is ICD 10 diagnostic code)  
Both D,E are  **wrong format** (They should be *755.2* and *001.9*)

### B. Data integration
These functions collapse ICD codes into a smaller number of clinically meaningful categories that are more useful for presenting descriptive statistics than are individual ICD diagnostic codes.  

The dxpr package supports four strategies to group EHR diagnosis codes, including CCS, PheWAS, comorbidities, and customized defined grouping methods.  

There are two types of output of code classification.

1) Usage: Select cases and calculate condition era 

**Table 2**  groupedDT

Short/Decimal|ID|ICD|Date|GroupType
----|--|-----|---|----
ICD short/Decimal|patient ID| ICD |Admission date| group of code classification

2) Usage: Convert the long format of grouped data into a wide format which is fit to others analytical and plotting packages.

**Table 3** summarised_groupedDT

ID|GroupType|FirstCaseDate|EndCaseDate|Count|Period
|---------|------------|--------------|--------------|------------|---------|
patient ICD|group of code classification|first admission date|last admission date|counts of period|record period

User can choose the type of classification is "category" or "description" (`isDescription` = `TRUE` or `FALSE`)

For example, the ccs description is "Tuberculosis" when the category is "1".

#### B-1. Clinical Classifications Software (CCS)
The CCS classification for ICD-9 and ICD-10 codes is a diagnostic categorization scheme that can employ in many types of projects analyzing data on diagnoses. 

**1) single-level**: `icdDxToCCS`

ICD-9-CM and ICD-10-CM code contains same 260 CCS categories.
```{r, message = FALSE, warning = FALSE}
## ICD to CCS category's description 
CCS_description <- icdDxToCCS(dxDataFile = sampleDxFile,
                              idColName = ID,
                              icdColName = ICD,        
                              dateColName = Date,
                              icd10usingDate = "2015-10-01",
                              isDescription = TRUE)
head(CCS_description$groupedDT, 5)
head(CCS_description$summarised_groupedDT, 5)
## ICD to CCS category
CCS_category <- icdDxToCCS(dxDataFile = sampleDxFile, 
                          idColName = ID,         
                          icdColName = ICD,       
                          dateColName = Date, 
                          icd10usingDate = "2015-10-01",
                          isDescription = FALSE)
```
**2) multi-level**: `icdDxToCCSLvl`

ICD-9-CM has four levels, and ICD-10-CM has two levels
```{r, message = FALSE, warning = FALSE}
## ICD to CCS multiple level 2 description
CCSlvl_description <- icdDxToCCSLvl(dxDataFile = sampleDxFile,
                                    idColName = ID,  
                                    icdColName = ICD,   
                                    dateColName = Date,
                                    icd10usingDate = "2015-10-01",
                                    CCSLevel = 2,
                                    isDescription = TRUE)
head(CCSlvl_description$groupedDT, 5)
head(CCSlvl_description$summarised_groupedDT, 5)
## ICD to CCS multiple level 3 category
CCSLvl_category <- icdDxToCCSLvl(dxDataFile = sampleDxFile,
                                    idColName = ID,  
                                    icdColName = ICD,   
                                    dateColName = Date,
                                    icd10usingDate = "2015-10-01",
                                    CCSLevel = 3,
                                    isDescription = FALSE)
```
#### B-2. PheWAS
The dxpr package applied PheWAS, performing using a hierarchical grouping of ICD9 diagnostic codes.

```{r, message = FALSE, warning = FALSE}
## ICD to PheWAS
PheWAS <- icdDxToPheWAS(dxDataFile = sampleDxFile,
                         idColName = ID,           
                         icdColName = ICD,     
                         dateColName = Date,
                         icd10usingDate = "2015-10-01",
                         isDescription = FALSE)
PheWAS$groupedDT[7:11]
PheWAS$summarised_groupedDT[7:11]
```

#### B-3. Comorbidities
The dxpr package provides three grouping methods of comorbidity as below:

**1) AHRQ**
AHRQ comorbidity measure dataset is based on Elixhauser Comorbidity Index
```{r, message = FALSE, warning = FALSE}
AHRQ <- icdDxToComorbid(dxDataFile = sampleDxFile,
                        idColName = ID,           
                        icdColName = ICD,       
                        dateColName = Date,
                        icd10usingDate = "2015-10-01",
                        comorbidMethod = AHRQ)
AHRQ$groupedDT[160:164]
head(AHRQ$summarised_groupedDT, 5)
```
**2) Charlson**
Charlson comorbidity measure dataset is based on Quan's translations of the Charlson Comorbidity Index
```{r, message = FALSE, warning = FALSE}
Charlson <- icdDxToComorbid(dxDataFile = sampleDxFile,
                        idColName = ID,           
                        icdColName = ICD,       
                        dateColName = Date,
                        icd10usingDate = "2015-10-01",
                        comorbidMethod = charlson)
Charlson$groupedDT[160:164]
head(Charlson$summarised_groupedDT, 5)
```
**3) Elixhauser**
Elixhauser comorbidity measure data.

The Elixhauser Comorbidity Software is one in a family of databases and software tools developed as part of the Healthcare Cost and Utilization Project (HCUP).
```{r, message = FALSE, warning = FALSE}
ELIX <- icdDxToComorbid(dxDataFile = sampleDxFile,
                        idColName = ID,           
                        icdColName = ICD,       
                        dateColName = Date,
                        icd10usingDate = "2015-10-01",
                        comorbidMethod = elix)
ELIX$groupedDT[160:164]
head(ELIX$summarised_groupedDT, 5)
```

#### B-4. Customize group method
The dxpr package provided customized grouping functions, which researches can define the grouping categories and therefore have more flexible for grouping ICD diagnostic codes. 

For example, researcher can convert an existing dataset into a grouped **chronic kidney disease** dataset in patients, and declare a customized grouping table for chronic kidney disease.  
There are two functions for customized defined grouping method, the customized category grouping is based on precise and fuzzy grouping method, respectively.  

**1) Precise method**: icdDxToCustom
```{r, message = FALSE, warning = FALSE}
# CustomGroupingTable 
groupingTable <- data.frame(Group = rep("Chronic kidney disease",6),
                            ICD = c("N181","5853","5854","5855","5856","5859"),
                            stringsAsFactors = FALSE)
CustomGroup <- icdDxToCustom(dxDataFile = sampleDxFile,  
                             idColName = ID,         
                             icdColName = ICD,  
                             dateColName = Date,
                             customGroupingTable = groupingTable)
CustomGroup$groupedDT[10:14]
head(CustomGroup$summarised_groupedDT, 5)
```
**2) Fuzzy method**: icdDxToCustomGrep
```{r, message = FALSE}
# CustomGroupingTable
grepTable <- data.frame(Group = "Chronic kidney disease",
                        grepIcd = "^585|^N18",
                        stringsAsFactors = FALSE)
CustomGrepGroup <- icdDxToCustomGrep(dxDataFile = sampleDxFile, 
                                    idColName = ID,            
                                    icdColName = ICD,   
                                    dateColName = Date,
                                    customGroupingTable = grepTable)
CustomGrepGroup$groupedDT[10:14]
head(CustomGrepGroup$summarised_groupedDT, 5)
```

## II. Data Wrangling

### A. Cases selection 
The query function `selectCases` can select the cases matching defined conditions. User can select cases by diagnostic categories, such as CCS category, ICD codes, etc. 

searching criteria for example, 

1)     Querying conditions

    `groupDataType`: Choose the method  of code classification: ICD, CCS, PheWAS, comorbidity or customized group method
    
    `caseCondition`: Certain diseases of standard groups by the `groupDataType` given above
    
2)     Searching range

　　　`PeriodRange `: Determine the interval days of interest for performing the case selection. By default, it set from 30 to 365 days.

3)     Minimum number of diagnoses

　　　`caseCount`: A threshold of number of ICD for case selection  
```{r, message = FALSE, warning = FALSE}
Case <- selectCases(dxDataFile = sampleDxFile,
                    idColName = ID,           
                    icdColName = ICD,       
                    dateColName = Date,
                    groupDataType = ccslvl2,
                    icd10usingDate = "2015/10/01",
                    caseCondition = "Diseases of the urinary system",
                    caseCount = 1,
                    caseName = "Selected")
head(Case)                   
```
### B. Get eligible period of patient records
The function used for querying the earliest and latest admission date for each patient.
```{r, message = FALSE}
admissionDate <- getEligiblePeriod(dxDataFile = sampleDxFile,
                                   idColName = ID,
                                   dateColName = Date)
head(admissionDate)                                  
```
### C. Data split
Extract data by a specific clinical event (e.g., first diagnosis dates of chronic diseases).  
Users can define a table of clinical index dates of each patient. The date can generate by selectCases function or first/last admission date by getEligiblePeriod function.  

Split data by the clinical event date and shows the data recorded before or after the clinical event and the window counts, which is the gap between the record date and index date. 
```{r, message = FALSE}
indexDateTable <- data.frame(ID = c("A0","B0","C0","D0"),
                             indexDate = c("2009-07-25", "2015-12-26",
                                           "2015-12-05", "2017-01-29"),
                             stringsAsFactors = FALSE)
Data <- splitDataByDate(dxDataFile = sampleDxFile,
                        idColName = ID,
                        icdColName = ICD,
                        dateColName = Date,
                        indexDateFile = indexDateTable,
                        gap = 30) 
head(Data, 5)
```
### D. Condition era
Calculate condition era by grouped categories of each patient.  
Conditions era is used to integrate distributed data of clinical records into a single progression record when the interval of admission data is smaller than the length of condition gap, and these admission data are considered same condition era.  
The first case date is the start date of the first condition of the group category for each patient.
The end case date is the end date of the last condition of the group category for each patient.
```{r, message = FALSE, warning = FALSE}
Era <- getConditionEra(dxDataFile = sampleDxFile,
                       idColName = ID,
                       icdColName = ICD,
                       dateColName = Date,
                       icd10usingDate = "2015-10-01", 
                       gapDate = 30,
                       groupDataType = ccs,
                       isDescription = FALSE)
head(Era)                       
```
### E. EDA preparation
After data integration, dxpr package provides function to convert long format of grouped data into wide format which is fit to others analytical and plotting packages.  

There are two type of output: numeric and binary (`numericOrBinary` = `B` or `N` )  
```{r, message = FALSE, warning = FALSE}
#binary
groupedData_Wide <- groupedDataLongToWide(dxDataFile = ELIX$groupedDT, 
                                          idColName = ID,    
                                          categoryColName = Comorbidity,   
                                          dateColName = Date,
                                          numericOrBinary = B)
                                          
head(groupedData_Wide, 5)
```

```{r, message = FALSE, warning = FALSE}
# numeric
groupedData_Wide <- groupedDataLongToWide(dxDataFile = ELIX$groupedDT, 
                                          idColName = ID,    
                                          categoryColName = Comorbidity,   
                                          dateColName = Date,
                                          numericOrBinary = N)
head(groupedData_Wide, 5)
```
## III. Visualization
Overview of grouped clinical data.

### A. Pareto chart of error ICD list
Through first phase function, code standardization, which generates a data of diagnosis codes with potential error.  
The Pareto chart includes bar plot and line chart to visualize individual possible error ICD codes represented in descending order and cumulative total.  

For instance, user choose top 10 of common error ICD, then the output shows a Pareto chart with top 10 error codes and a list of the detail of error ICD codes.  
```{r, message = FALSE, warning = FALSE}
error <- icdDxDecimalToShort(dxDataFile = sampleDxFile,
                            icdColName = ICD,
                            dateColName = Date,
                            icd10usingDate = "2015/10/01")
Plot_error1 <- plotICDError(errorFile = error$Error,
                            icdVersion = all,
                            wrongICDType = all,
                            others = TRUE)
```
<img src="https://raw.githubusercontent.com/DHLab-TSENG/dxpr/master/image/plotICDError.png" style="display:block; margin:auto; width:70%;">
Plot of top 10 common error ICD codes and a list of the detail of error ICD codes  
The Top 1 common error ICD is *A0.11* which has 20 admission records and error type is "wrong format"
```{r, message = FALSE}
Plot_error1$ICD
```
Also, user can divide **ICD-9** by the prefix of the ICD code: 0, 1, 2,..., 9, V and E  (`groupICD = TRUE`)

ICD-9-CM divided into 19 chapters:  
　001-139: Infectious And Parasitic Diseases  
　140-239: Neoplasms  
　....  

For instance, user choose top 3 of common error *ICD-9*, then the output shows a Pareto chart with top 3 error codes and a list of the detail of error ICD codes.  
```{r, message = FALSE}
Plot_error2 <- plotICDError(errorFile = error$Error,
                             icdVersion = 9,
                             wrongICDType = all,
                             groupICD = TRUE,
                             others = TRUE,
                             topN = 3)
```
<img src="https://raw.githubusercontent.com/DHLab-TSENG/dxpr/master/docs/reference/plotError-1.png" style="display:block; margin:auto; width:70%;">
Plot of top 3 common error ICD-9 codes and a list of the detail of error ICD codes  
The Top 1 common error ICD is *A01.05* which has 13 admission records and error type is "wrong version"
```r
Plot_error2$ICD
#>    ICDGroup groupCount CumCountPerc MostICDInGroup ICDPercInGroup     WrongType
#> 1:        A         13       41.94%         A01.05         61.54% Wrong version
#> 2:        7          9       70.97%          75.52         44.44%  Wrong format
00#> 3:        0          5        87.1%            001           100%  Wrong format
#> 4:   Others          4         100%          E03.0           100% Wrong version
```
### B. histogram plot
This function provides an overview of grouping category of the diagnostic code and summarize the percentage of result in histogram plot. User can observe the number of diagnostic categories in their dataset.  

```{r, message = FALSE, warning = FALSE}
groupedDataWide <- groupedDataLongToWide(ELIX$groupedDT,
                                         idColName = ID,
                                         categoryColName = Comorbidity,
                                         dateColName = Date)
plot1 <- plotDiagCat(groupedDataWide = groupedDataWide,
                     idColName = ID,
                     topN = 10,
                     limitFreq = 0.01)
```
<img src="https://raw.githubusercontent.com/DHLab-TSENG/dxpr/master/image/plotDiagSing.png" style="display:block; margin:auto; width:70%;"> 
The first group, for instance, is grouped into "RENLFAIL" of ELIX comorbidity index.  
```{r}
plot1$sigCate
```
This function also verifies by Chi-square test and Fisher’s exact test statistical significantly different diagnostic categories between case and control.
The default level of significance considered at 5% (p = 0.05). 

```{r, message = FALSE, warning = FALSE}
selectedCaseFile <- selectCases(dxDataFile = sampleDxFile,
                                idColName = ID,
                                icdColName = ICD,
                                dateColName = Date,
                                icd10usingDate = "2015/10/01",
                                groupDataType = ccslvl2,
                                caseCondition = "Diseases of the urinary system",
                                caseCount = 1)
                                
groupedDataWide <- groupedDataLongToWide(ELIX$groupedDT, ID, Comorbidity, Date,
                                         selectedCaseFile = selectedCaseFile)
plot2 <- plotDiagCat(groupedDataWide = groupedDataWide,
                     idColName = ID,
                     groupColName = selectedCase,
                     topN = 10,
                     limitFreq = 0.01,
                     pvalue = 0.05)
```

<img src="https://raw.githubusercontent.com/DHLab-TSENG/dxpr/master/image/plotDiagMult.png" style="display:block; margin:auto; width:70%;">
There are stastitcal significant different in "RENLFAIL" of ELIX comorbidity index between case and control.  

```{r}
plot2$sigCate
```
## Reference
### I. Code transformation

ICD-9-CM code (2014): https://www.cms.gov/Medicare/Coding/ICD9ProviderDiagnosticCodes/codes.html

ICD-10-CM code (2019): https://www.cms.gov/Medicare/Coding/ICD10/2019-ICD-10-CM.html

https://www.cms.gov/Medicare/Coding/ICD10/2019-ICD-10-CM.html

https://www.findacode.com/search/search.php

https://www.cms.gov/Medicare/Quality-Initiatives-Patient-Assessment-Instruments/HospitalQualityInits/Downloads/HospitalAppendix_F.pdf

### II. Code grouping

**CCS (Clinical Classifications Software)**

ICD-9-CM (2015): https://www.hcup-us.ahrq.gov/toolssoftware/ccs/Single_Level_CCS_2015.zip

https://www.hcup-us.ahrq.gov/toolssoftware/ccs/Multi_Level_CCS_2015.zip

ICD-10-CM (2019): https://www.hcup-us.ahrq.gov/toolssoftware/ccs10/ccs_dx_icd10cm_2019_1.zip

**PheWAS**

ICD-9-Phecode (version 1.2, 2015): https://phewascatalog.org/phecodes

**Comorbidities**

ICD-9-AHRQ (2012-2015): https://www.hcup-us.ahrq.gov/toolssoftware/comorbidity/comorbidity.jsp#references

ICD-10-AHRQ (2019): https://www.hcup-us.ahrq.gov/toolssoftware/comorbidityicd10/comformat_icd10cm_2019_1.txt

ICD-9-Charlson: http://mchp-appserv.cpe.umanitoba.ca/Upload/SAS/ICD9_E_Charlson.sas.txt

ICD-10-Charlson: http://mchp-appserv.cpe.umanitoba.ca/Upload/SAS/ICD10_Charlson.sas.txt

ICD-9-Elixhauser (2012-2015): https://www.hcup-us.ahrq.gov/toolssoftware/comorbidity/comorbidity.jsp#references

ICD-10-Elixhauser (2019): https://www.hcup-us.ahrq.gov/toolssoftware/comorbidityicd10/comformat_icd10cm_2019_1.txt
