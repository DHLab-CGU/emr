---
title: "Getting started with emr"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to emr}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

 Introduction
```
cat(utils::packageDescription("emr")$Description)
```
### ICD-CM code with two format
conversion function : `IcdDxDecimaltoShort and IcdDxShortToDecimal`

ICD-9-CM
```
icd9_Short <- head(ICD9DxwithTwoFormat$Short, 10)
# c("E0000", "E0001", "E0002", "E0008", "E0009", "E0010", "E0011", "E0020", "E0021", "E0022")
icd9_Decimal <- head(ICD9DxwithTwoFormat$Decimal,10)
# c("E000.0", "E000.1", "E000.2", "E000.8", "E000.9", "E001.0", "E001.1", "E002.0", "E002.1", "E002.2")
```
ICD-10-CM
```
icd10_Short <- head(ICD10DxwithTwoFormat$Short, 10)
# c("A001",  "A009",  "A0100", "A0101", "A0102", "A0103", "A0104", "A0105", "A0109", "A011")
icd10_Decimal <- head(ICD10DxwithTwoFormat$Decimal,10)
# c("A00.1",  "A00.9",  "A010.0", "A010.1", "A010.2", "A010.3", "A010.4", "A010.5", "A010.9", "A01.1")
```
## I.Code standarization
According to the using format of function, these conversion function can be used to convert ICD codes between types.

Convert ICD-CM code Short to Decimal.
```
# Short to decimal
decimal <- IcdDxShortToDecimal(sampleDxFile, ICD, Date, "2015/10/01")
head(decimal$ICD)
# c("553.3", "553.3", "553.20", "553.20", "553.3", "K44.9")

```
Convert ICD-CM code Decimal to Short.
```
# Decimal to short
short <- IcdDxDecimalToShort(sampleDxFile, ICD, Date, "2015/10/01")
head(short$ICD)
# c("5533", "5533", "55320", "55320", "5533", "K449")

```
## II. Data integration
Grouping ICD-9 and ICD-10 codes by: Classifying ICD-9-CM and ICD-10-CM diagnoses codes into clinically meaningful categories, which can be used for aggregate statistical reporting of a variety of types.

### A. Clinical Classifications Software (CCS)
It is based on the CCS for ICD-9-CM and attempts to map ICD-10-CM/PCS codes into the same categories. and get the CCS categories and description by ICD-9/ICD-10 code.

**1) CCS single-level category**
`IcdDxToCCS` can get CCS categories or description for ICD-9 and ICD-10 codes on diagnoses.

ICD-9-CM and ICD-10-CM code contains same 260 CCS categories.
```
## ICD to CCS description
CCS_description <- IcdDxToCCS(sampleDxFile, ID, ICD, Date, "2015-10-01", TRUE)
head(CCS_description$groupedDT, 5)
#>       Short ID    ICD       Date           CCS_CATEGORY_DESCRIPTION
#>   1:   5533  C  553.3 2008-04-03                   Abdominal hernia
#>   2:   5533  A  553.3 2008-05-01                   Abdominal hernia
#>   3:  55320  A 553.20 2009-02-23                   Abdominal hernia
#>   4:  55320  B 553.20 2007-08-29                   Abdominal hernia
#>   5:   5533  A  553.3 2008-06-27                   Abdominal hernia

head(CCS_description$summarised_groupedDT, 5)
#>     ID   CCS_CATEGORY_DESCRIPTION  firstCaseDate endCaseDate count    period
#>  1:  C           Abdominal hernia     2008-04-03  2018-12-28     2 3921 days
#>  2:  A           Abdominal hernia     2008-05-01  2018-12-28     4 3893 days
#>  3:  B           Abdominal hernia     2007-08-29  2019-11-10     2 4456 days
#>  4:  B           Acute bronchitis     2008-04-29  2008-04-29     1    0 days
#>  5:  A           Acute bronchitis     2009-06-09  2009-06-09     1    0 days

## ICD to CCS category
CCS_category <- IcdDxToCCS(sampleDxFile, ID, ICD, Date, "2015-10-01", FALSE)
```
**2) CCS multi-level** 
`IcdDxToCCSLvl` can get CCS multiple levels or description for ICD-9 and ICD-10 codes on diagnoses.

ICD-9-CM has four levels

ICD-10-CM has two levels
```
## ICD to CCS multiple level 2 description
CCSlvl_description <- IcdDxToCCSLvl(sampleDxFile, ID, ICD, Date, "2015-10-01", 2, TRUE)
head(CCSlvl_description$groupedDT, 5)
#>       Short ID    ICD       Date      CCS_LVL_2_LABEL
#>   1:   5533  C  553.3 2008-04-03     Abdominal hernia
#>   2:   5533  A  553.3 2008-05-01     Abdominal hernia
#>   3:  55320  A 553.20 2009-02-23     Abdominal hernia
#>   4:  55320  B 553.20 2007-08-29     Abdominal hernia
#>   5:   5533  A  553.3 2008-06-27     Abdominal hernia

head(CCSlvl_description$summarised_groupedDT, 5)
#>     ID                                       CCS_LVL_2_LABEL firstCaseDate endCaseDate count     period
#>  1:  C                                      Abdominal hernia    2008-04-03  2018-12-28     2  3921 days
#>  2:  A                                      Abdominal hernia    2008-05-01  2018-12-28     4  3893 days
#>  3:  B                                      Abdominal hernia    2007-08-29  2019-11-10     2  4456 days
#>  4:  B                                Respiratory infections    2008-04-29  2008-04-29     1     0 days
#>  5:  A                                Respiratory infections    2009-06-09  2009-06-09     1     0 days

## ICD to CCS multiple level 3 category
CCSLvl_category <- IcdDxToCCSLvl(sampleDxFile, ID, ICD, Date, "2015-10-01", 3, FALSE)
```
### B. Phecode
`IcdDxToPhecode` allows  for conversion and aggregate ICD9 codes into PheWAS codes (Phecode).

This can be used to group Phecode or description of phecode (phenotype) by ICD-9 diagnosis codes in clinical diagnostic data.

more detail: https://www.vumc.org/cpm/cpm-blog/phewas-phenome-wide-association-studies
```
## ICD to Phecode
phecode <- IcdDxToPhecode(sampleDxFile, ID, ICD, Date, "2015-10-01", FALSE)
head(phecode$groupedDT, 5)
#>        ICDD ID    ICD       Date PheCode
#>   1:  553.3  C  553.3 2008-04-03   550.2
#>   2:  553.3  A  553.3 2008-05-01   550.2
#>   3: 553.20  A 553.20 2009-02-23   550.5
#>   4: 553.20  B 553.20 2007-08-29   550.5
#>   5:  553.3  A  553.3 2008-06-27   550.2
head(phecode$summarised_groupedDT, 5)
#>     ID PheCode firstCaseDate endCaseDate count   period
#>  1:  C   550.2    2008-04-03  2008-04-03     1   0 days
#>  2:  A   550.2    2008-05-01  2008-06-27     2  57 days
#>  3:  A   550.5    2009-02-23  2009-02-23     1   0 days
#>  4:  B   550.5    2007-08-29  2007-08-29     1   0 days
#>  5:  B     483    2008-04-29  2008-04-29     1   0 days

```
### C. Creating a grouping standards
User can identify the rule of grouping standards, and return matched ICD codes.

**1) IcdDxToCustom** Use method of exhaustion to find out the matched ICD.
```{r}
# groupingTable 
groupingTable <- data.frame(group = rep("Cardiac dysrhythmias",6),
                            ICD = c("427.1","427.2","427.31","427.61","427.81","427.89"),
                            stringsAsFactors = FALSE)
```
```
CustomGroup <- IcdDxToCustom(sampleDxFile, ID, ICD, Date, CustomGroupingTable = groupingTable)
CustomGroup$groupedDT[10:15]
#>     ICD   ID       Date                group
#> 1:  466.0  A 2009-06-09                 <NA>
#> 2: 427.61  A 2009-02-16 Cardiac dysrhythmias
#> 3: 427.31  C 2007-06-20 Cardiac dysrhythmias
#> 4: 427.89  C 2008-01-23 Cardiac dysrhythmias
#> 5: 427.31  A 2007-09-19 Cardiac dysrhythmias
#> 6: 427.31  C 2008-09-11 Cardiac dysrhythmias
CustomGroup$summarised_groupedDT
#>    ID                group firstCaseDate endCaseDate count   period
#> 1:  A Cardiac dysrhythmias    2007-07-27  2009-02-16     4 570 days
#> 2:  C Cardiac dysrhythmias    2007-06-20  2009-02-08     9 599 days
#> 3:  B Cardiac dysrhythmias    2007-07-16  2009-02-25     5 590 days
```
**2) IcdDxToCustomGrep** Use a ICD pattern to find out the fit ICD.
```{r}
# grepTable
grepTable <- data.frame(group = "Cardiac dysrhythmias",
                        grepIcd = "^427|^I48",
                        stringsAsFactors = FALSE)
```
```
CustomGrepGroup <- IcdDxToCustomGrep(sampleDxFile, ID, ICD, Date, CustomGroupingTable = grepTable)
CustomGrepGroup$groupedDT[10:15]
#>    ID    ICD       Date                group
#> 1:  A  466.0 2009-06-09                     
#> 2:  A 427.61 2009-02-16 Cardiac dysrhythmias
#> 3:  C 427.31 2007-06-20 Cardiac dysrhythmias
#> 4:  C 427.89 2008-01-23 Cardiac dysrhythmias
#> 5:  A 427.31 2007-09-19 Cardiac dysrhythmias
#> 6:  C 427.31 2008-09-11 Cardiac dysrhythmias

CustomGrepGroup$summarised_groupedDT
#>    ID                group firstCaseDate endCaseDate count    period
#> 1:  A Cardiac dysrhythmias    2007-07-27  2021-12-13    10 5253 days
#> 2:  C Cardiac dysrhythmias    2007-06-20  2021-09-16    16 5202 days
#> 3:  B Cardiac dysrhythmias    2007-07-16  2020-10-11    10 4836 days
```

### D. Comorbidities
The comorbidities measures from different sources are provided as lists. There are three comorbidities sources: AHRQ, Charlson, and Elixhauser Comorbidity.

**1) AHRQ**
AHRQ comorbidity measure dataset is based on Elixhauser Comorbidity Index
```
AHRQ <- IcdDxToComorbid(sampleDxFile, ID, ICD, Date, "2015-10-01", ahrq)
AHRQ$groupedDT[160:164]
#>    Short ID    ICD       Date Comorbidity
#> 1: K7460  C K74.60 2021-01-09       Liver
#> 2:  Z720  A  Z72.0 2020-04-29        <NA>
#> 3: G2581  B G25.81 2021-06-24  NeuroOther
#> 4: Z6832  C Z68.32 2019-10-16     Obesity
#> 5: 42761  A  42761 2020-03-16        <NA>

head(AHRQ$summarised_groupedDT, 5)
#>    ID Comorbidity firstCaseDate endCaseDate count    period
#> 1:  A       Renal    2007-05-12  2019-08-15    31 4478 days
#> 2:  C       Renal    2007-04-21  2021-09-17    31 5263 days
#> 3:  B       Renal    2007-05-28  2022-03-18    33 5408 days
#> 4:  C       Liver    2021-01-09  2021-01-09     1    0 days
#> 5:  B  NeuroOther    2021-06-24  2021-06-24     1    0 days

```
**2) Charlson**
Charlson comorbidity measure dataset is based on Quan's translations of the Charlson Comorbidity Index
```
Charlson <- IcdDxToComorbid(sampleDxFile, ID, ICD, Date, "2015-10-01", charlson)
Charlson$groupedDT[160:164]
#>    Short ID    ICD       Date Comorbidity
#> 1: K7460  C K74.60 2021-01-09   LiverMild
#> 2:  Z720  A  Z72.0 2020-04-29        <NA>
#> 3: G2581  B G25.81 2021-06-24        <NA>
#> 4: Z6832  C Z68.32 2019-10-16        <NA>
#> 5: 42761  A  42761 2020-03-16        <NA>

head(Charlson$summarised_groupedDT, 5)
#>    ID Comorbidity firstCaseDate endCaseDate count    period
#> 1:  A       Renal    2007-05-12  2022-02-08    33 5386 days
#> 2:  C       Renal    2007-04-21  2021-09-17    33 5263 days
#> 3:  B       Renal    2007-05-28  2022-03-18    34 5408 days
#> 4:  C   LiverMild    2021-01-09  2021-01-09     1    0 days
```
**3) Elixhauser**
Elixhauser comorbidity measure data.

The Elixhauser Comorbidity Software is one in a family of databases and software tools developed as part of the Healthcare Cost and Utilization Project (HCUP).
```
ELIX <- IcdDxToComorbid(sampleDxFile, ID, ICD, Date, "2015-10-01", elix)
ELIX$groupedDT[160:164]
#>    Short ID    ICD       Date Comorbidity
#> 1: K7460  C K74.60 2021-01-09     HYPOTHY
#> 2:  Z720  A  Z72.0 2020-04-29        <NA>
#> 3: G2581  B G25.81 2021-06-24        METS
#> 4: Z6832  C Z68.32 2019-10-16       NEURO
#> 5: 42761  A  42761 2020-03-16        <NA>

head(ELIX$summarised_groupedDT, 5)
#>     ID Comorbidity firstCaseDate endCaseDate count    period
#>  1:  A    RENLFAIL    2007-05-12  2009-04-26    28  715 days
#>  2:  C    RENLFAIL    2007-04-21  2021-09-17    29 5263 days
#>  3:  B    RENLFAIL    2007-05-28  2022-03-03    29 5393 days
#>  4:  B    PULMCIRC    2019-03-11  2022-03-18     4 1103 days
#>  5:  C    PULMCIRC    2019-12-28  2020-05-10     2  134 days
```
### E. Cases selection 
This can be used to select qualified cases from factIcd data based on the ICD code searching criteria and number of ICD code per patients in the inout factIcd dataset.

searching criteria for example, 

1) ICD pattern: the ICD begining with "I0"

2) The specific ICD appears at least twice

3) Interval of days: 30 ~ 365 days, the days between two specific ICD codes.

Return the matched Data frame.

```
selectCases(DxDataFile = sampleDxFile,
            ID, ICD, Date,
            groupDataType = ccslvl2,
            icd10usingDate = "2015/10/01",
            caseCondition = "Diseases of the heart",
            caseCount = 2)
#>    ID selectedCase count firstCaseDate endCaseDate period MostCommonICD  MostCommonICDCount
#> 1:  A     Selected     4    2021-08-02  2022-02-20    202        I48.91                   4
#> 2:  B     Selected     4    2007-07-16  2009-02-25    348        427.31                   3
#> 3:  C     Selected     6    2007-06-20  2009-02-08    255        427.31                   3
#> 4:  D  nonSelected    NA          <NA>        <NA>     NA          <NA>                <NA>   
```
### F. first/last event of patient admission

```
patientRecordDate(sampleDxFile, ID, ICD, Date)
#>    ID firstRecordDate endRecordDate
#> 1:  D      2006-05-03    2018-10-02
#> 2:  A      2006-05-03    2022-02-20
#> 3:  B      2006-05-03    2022-03-18
#> 4:  C      2007-04-21    2021-09-17
```
### G. Data split

```
indexDateTable <- data.frame(ID = c("A", "B", "C", "D"),
                             indexDate = c("2006-05-03", "2006-05-03",
                                           "2008-03-30", "2006-05-03"),
                             stringsAsFactors = FALSE)
Data <- splitDataByDate(sampleDxFile, ID, ICD, Date,
                indexDateFile = indexDateTable,
                windowGap = 30) 
head(Data, 5)
     ID    ICD       Date  indexDate timeTag window
  1:  A 785.52 2006-05-03 2006-05-03       A      1
  2:  A  V56.0 2007-05-12 2006-05-03       A     13
  3:  A V45.11 2007-05-30 2006-05-03       A     14
  4:  A  427.1 2007-07-27 2006-05-03       A     16
  5:  A  585.2 2007-08-08 2006-05-03       A     16
```
### H. Condition Era
Get the condition era

Condition Eras are built with a Persistence Window, deafault is 30 days.
```
getConditionEra(sampleDxFile, ID, ICD, Date, "2016-01-01", 30, ccs, FALSE)
#>     ID CCS_CATEGORY firstCaseDate endCaseDate count Era    period
#>  1:  C          158    2007-04-21  2021-09-17    33  16 5263 days
#>  2:  B          158    2007-05-28  2022-03-18    34  14 5408 days
#>  3:  C          106    2007-06-20  2021-09-16    19  14 5202 days
#>  4:  A          158    2007-05-12  2022-02-08    33  12 5386 days
#>  5:  B          106    2007-07-16  2020-10-11    13  10 4836 days

grepTable <- data.frame(group = "Cardiac dysrhythmias",
                        grepIcd = "^427|^I48",
                        stringsAsFactors = FALSE)
getConditionEra(sampleDxFile, ID, ICD, Date, "2015-10-01", 30, customGrepIcdGroup, CustomGroupingTable = grepTable)
#>    ID                group firstCaseDate endCaseDate count Era    period
#> 1:  C Cardiac dysrhythmias    2007-06-20  2021-09-16    16  12 5202 days
#> 2:  A Cardiac dysrhythmias    2007-07-27  2021-12-13    10   9 5253 days
#> 3:  B Cardiac dysrhythmias    2007-07-16  2020-10-11    10   9 4836 days
```
## III. EDA preparation
```
groupedDataLongToWide(sampleDxFile, ID, ICD, Date, "2015-10-01", ccs, numericOrBinary = B)
groupedDataLongToWide(sampleDxFile, ID, ICD, Date, "2015-10-01", ccs, numericOrBinary = N)
```
## IV. Visualization
```
error <- IcdDxDecimalToShort(sampleDxFile, ICD, Date, "2015/10/01")
plot_errorICD(error$Error, ICDVersion = all,
                           wrongICDType = all,
                           groupICD = FALSE,
                           Others = FALSE,
                           OthersThreshold = 1)
```
![warning message](https://dhlab-cgu.github.io/emr/reference/plot_errorICD-1.png)
```
#> $ICD
#>        ICD count IcdVersionInFile     WrongType Suggestion CumCountPerc
#>  1:  A0.11    20           ICD 10  Wrong format                   22.47
#>  2:  V27.0    18           ICD 10 Wrong version                   42.70
#>  3:   E114     8           ICD 10  Wrong format                   51.69
#>  4: A01.05     8            ICD 9 Wrong version                   60.67
#>  5:  42761     7           ICD 10 Wrong version                   68.54
#>  6:  Z9.90     6           ICD 10  Wrong format                   75.28
#>  7:    F42     6           ICD 10  Wrong format                   82.02
#>  8:  V24.1     6           ICD 10 Wrong version                   88.76
#>  9:  A0105     5            ICD 9 Wrong version                   94.38
#> 10:    001     5            ICD 9  Wrong format       0019       100.00
```
## V. Reference
### I. ICD function of conversion

ICD-9-CM code (2014): https://www.cms.gov/Medicare/Coding/ICD9ProviderDiagnosticCodes/codes.html

ICD-10-CM code (2019): https://www.cms.gov/Medicare/Coding/ICD10/2019-ICD-10-CM.html

https://www.cms.gov/Medicare/Coding/ICD10/2019-ICD-10-CM.html

https://www.findacode.com/search/search.php

https://www.cms.gov/Medicare/Quality-Initiatives-Patient-Assessment-Instruments/HospitalQualityInits/Downloads/HospitalAppendix_F.pdf

### II. Data integration

**CCS (Clinical Classifications Software)**

ICD-9-CM (2015): https://www.hcup-us.ahrq.gov/toolssoftware/ccs/Single_Level_CCS_2015.zip

https://www.hcup-us.ahrq.gov/toolssoftware/ccs/Multi_Level_CCS_2015.zip

ICD-10-CM (2019): https://www.hcup-us.ahrq.gov/toolssoftware/ccs10/ccs_dx_icd10cm_2019_1.zip

**Phecode**

ICD-9-Phecode (version 1.2, 2015): https://phewascatalog.org/phecodes

**Comorbidities**

ICD-9-AHRQ (2012-2015): https://www.hcup-us.ahrq.gov/toolssoftware/comorbidity/comorbidity.jsp#references

ICD-10-AHRQ (2019): https://www.hcup-us.ahrq.gov/toolssoftware/comorbidityicd10/comformat_icd10cm_2019_1.txt

ICD-9-Charlson: http://mchp-appserv.cpe.umanitoba.ca/Upload/SAS/ICD9_E_Charlson.sas.txt

ICD-10-Charlson: http://mchp-appserv.cpe.umanitoba.ca/Upload/SAS/ICD10_Charlson.sas.txt

ICD-9-Elixhauser (2012-2015): https://www.hcup-us.ahrq.gov/toolssoftware/comorbidity/comorbidity.jsp#references

ICD-10-Elixhauser (2019): https://www.hcup-us.ahrq.gov/toolssoftware/comorbidityicd10/comformat_icd10cm_2019_1.txt
