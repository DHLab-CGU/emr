---
title: "Get Started: Diagnosis"

author: "Hsiang-Ju, Chiu"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Chinese Version}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# 診斷前處理與整合方法

```
cat(utils::packageDescription("emr")$Description)
```
### 安裝套件
```r
install.packages("devtools")
# Install development version from GitHub
devtools::install_github("DHLab-CGU/emr")
library(emr)
```
### ICD-CM-CODE 格式對照

本套件使用的診斷編碼依照CMS (Centers for Medicare & Medicaid Services)所提供的診斷編碼做為標準依據，並依照WHO訂定的診斷編碼規則，分別產生 ICD-9-CM and ICD-10-CM 的兩種格式的表格: `ICD9DxwithTwoFormat 和 ICD10DxwithTwoFormat`

供後續診斷編碼格式轉換的功能使用 

ICD-9-CM
```r
# icd9_Short
head(ICD9DxwithTwoFormat$Short)
# c("E0000", "E0001", "E0002", "E0008", "E0009", "E0010")
# icd9_Decimal
head(ICD9DxwithTwoFormat$Decimal)
# c("E000.0", "E000.1", "E000.2", "E000.8", "E000.9", "E001.0")
```
ICD-10-CM
```r
# icd10_Short
head(ICD10DxwithTwoFormat$Short)
# c("A001",  "A009",  "A0100", "A0101", "A0102", "A0103")
# icd10_Decimal
head(ICD10DxwithTwoFormat$Decimal)
# c("A00.1",  "A00.9",  "A010.0", "A010.1", "A010.2", "A010.3")
```
### 範例資料

以下功能介紹皆以`sampleDxFile`做為範例，該資料共有38位病患，300筆診斷紀錄
```r
head(sampleDxFile)
#     ID  ICD       Date
# 1:  A2 Z992 2020-05-22
# 2:  A5 Z992 2020-01-24
# 3:  A8 Z992 2015-10-27
# 4: A13 Z992 2020-04-26
# 5: A13 Z992 2025-02-02
# 6: A15 Z992 2023-05-12
```
## I. Code standarization

**ICD-9-CM and ICD-10-CM code兩種格式的轉換: Short <-> Decimal**

將醫療大數據中的診斷編碼進行編碼一致格式的轉換，以便後續診斷編碼的標準化分群。依據CCS（Clinical Classifications Software）、共病症（Comorbidity）及PheWAS的分組表中ICD診斷碼格式如**表一**。

**表一** 標準化分組之ICD格式

|   |ICD format|
|--------|----|
|Clinical Classifications Software|short format|
|Comorbidity |short format|
|PheWAS|decimal format|

舉例來說，當使用者欲進行CCS的標準化分組，在分組前必須先將資料的診斷編碼統一轉換為**short**的格式

疾病分組時，為能區別診斷編碼版本ICD-9/ICD-10，本套件依據**診斷日期**區分診斷編碼的版本，其時間切割點可依使用者需求設定。

如使用者分析台灣的醫療資料，ICD-10使用日期設定為2016年1月1日；

如使用者分析美國的醫療資料，ICD-10使用日期設定為2015年10月1日。

如範例，區分診斷編碼版本的日期為：2015年10月1日

**將 ICD-CM code 的格式統一轉成 Decimal**
```r
# Short to decimal
decimal <- IcdDxShortToDecimal(DxDataFile = sampleDxFile,
                               icdColName = ICD, 
                               dateColName = Date,
                               icd10usingDate = "2015/10/01")
decimal$ICD[6:10]
# c("Z99.2", "585.5", "V45.11", "V56.0", "585.3")
```
**將 ICD-CM code 的格式統一轉成 Short**
```r
# Decimal to short
short <- IcdDxDecimalToShort(DxDataFile = sampleDxFile,
                            icdColName = ICD,         
                            dateColName = Date,
                            icd10usingDate = "2015/10/01")
short$ICD[6:10]
# c("Z992", "5855", "V4511", "V560", "5853")
```
**warning message**

醫療數據的診斷編碼有可能誤植導致錯誤，而錯誤的診斷編碼將影響後續臨床疾病分組錯誤或是無法分組的情形。
為方便使用者修改錯誤的診斷編碼，emr套件會提供warning message提醒使用者那些錯誤的診斷編碼。

編碼錯誤的種類：**格式錯誤 (Wrong format)**及**版本分類錯誤 (Wrong version)**
```r
sample <- IcdDxShortToDecimal(DxDataFile = sampleDxFile,
                              icdColName = ICD, 
                              dateColName = Date,
                              icd10usingDate = "2015/10/01")
#> Wrong ICD format: total 9 ICD codes (the number of occurrences is in brackets)
#> c("A0.11 (20)", "E114 (8)", "Z9.90 (6)", "F42 (6)", "001 (5)", "75.52 (4)", "755.2 (3)", "123.45 (3)", "7552 (2)")
#> 	
#> Wrong ICD version: total 7 ICD codes (the number of occurrences is in brackets)
#> c("V27.0 (18)", "A01.05 (8)", "42761 (7)", "V24.1 (6)", "A0105 (5)", "E03.0 (4)", "650 (4)")
#> 	
#> Warning: The ICD mentioned above matches to "NA" due to the format or other issues.
#> Warning: "Wrong ICD format" means the ICD has wrong format
#> Warning: "Wrong ICD version" means the ICD classify to wrong ICD version (cause the "icd10usingDate" or other issues)
```

1) 診斷編碼格式錯誤：共9種診斷編碼 (括號內為該診斷編碼出現次數) 

  c("A0.11 (20)", "E114 (8)", "Z9.90 (6)", "F42 (6)", "001 (5)", "75.52 (4)", "755.2 (3)", "123.45 (3)", "7552 (2)")

2) 診斷編碼版本錯誤：共7種診斷編碼 (括號內為診斷編碼出現次數) 

  c("V27.0 (18)", "A01.05 (8)", "42761 (7)", "V24.1 (6)", "A0105 (5)", "E03.0 (4)", "650 (4)")

若想要看到全部的錯誤，可選擇`sample$Error`

將顯示錯誤的診斷編碼、出現次數、在檔案中編碼被判斷為何種版本、錯誤的類別及建議該如何修正
```r
sample$Error
#>        ICD count IcdVersionInFile     WrongType Suggestion
#>  1:  A0.11    20           ICD 10  Wrong format           
#>  2:  V27.0    18           ICD 10 Wrong version           
#>  3:   E114     8           ICD 10  Wrong format           
#>  4: A01.05     8            ICD 9 Wrong version           
#>  5:  42761     7           ICD 10 Wrong version           
#>  6:  Z9.90     6           ICD 10  Wrong format           
#>  7:    F42     6           ICD 10  Wrong format           
#>  8:  V24.1     6           ICD 10 Wrong version           
#>  9:  A0105     5            ICD 9 Wrong version           
#> 10:    001     5            ICD 9  Wrong format       0019
#> 11:  75.52     4            ICD 9  Wrong format           
#> 12:  E03.0     4            ICD 9 Wrong version           
#> 13:    650     4           ICD 10 Wrong version           
#> 14: 123.45     3           ICD 10  Wrong format           
#> 15:  755.2     3            ICD 9  Wrong format     755.29
#> 16:   7552     2            ICD 9  Wrong format      75529
```
除了錯誤編碼表格供使用者了解錯誤的種類數量；本套件另提供圖表功能(`plot_errorICD`)供使用者觀察錯誤編碼的分布情形。

**Warning message判斷流程**

以下為判斷診斷編碼錯誤之流程圖，將診斷編碼轉為 decimal 作為範例

![warning message](https://raw.githubusercontent.com/DHLab-CGU/dhlab-cgu.github.io/master/emr/warning.jpg)

1)將資料依照格式分為short及decimal兩部分

2-1)short的組別依照診斷編碼版本分組進行**第一次**格式轉換

ICD-9: C, E

ICD-10: A

2-2)decimal的組別依診斷編碼版本分組進行**第一次**確認格式正確性

ICD-9: B

ICD-10: D

3)第二步驟結束後，挑出有NA的個案 (A, C, D, E)，進行**第二次**的格式轉換和確認正確性。

A為ICD-10 code，因此將與`ICD9DxwithTwoFormat`進行**第二次**的確認及轉換

C, D, E為ICD-9 code，因此將與`ICD10DxwithTwoFormat`進行**第二次**的確認及轉換

若結果為`NA`，則表示該診斷編碼格式錯誤；反之結果`不是NA`，則表示該診斷編碼版本錯誤

如圖

A和C 結果不是NA，表示診斷編碼版本錯誤 (42761應為ICD 9的診斷編碼，A0105應為ICD 10的診斷編碼)

D和E 結果為NA，表示診斷編格式錯誤(應為755.2和001.9)

## II. Data integration

將分散的診斷編碼基於臨床意義整合成較大群組的疾病分組功能，以供後續分析使用。

目前套件提供四種標準化分組的種類，包括CCS階層式編碼轉換、PheWAS分群編碼、共病症（AHRQ、Charlson、Elixhauser Comorbidity）分組以及自定義診斷分組，以下將分別介紹之

經過四種標準化處理後, 可得兩種回傳的結果

1) **groupedDT**：如**表二**，將診斷編碼依國際標準轉換為有臨床意義的疾病分組。可用來計算疾病世代 (condition era)及選取合適的case組(selectCase)

**表二** 標準化分組後回傳的資料型態

|Short/Decimal|ID|ICD|Date|GroupType|
|----|--|-----|---|----|
|ICD short/Decimal格式|病患編碼|使用者輸入的診斷編碼 |診斷日期|標準化分組組別|

groupedDT將顯示完整的分組結果，如範例為300筆資料，groupedDT就會顯示300筆

2) **summarised_groupedDT**：如**表三**，將病患被歸類在同一個組別的多筆資料會統整成一筆資料。另可將其資料轉為適合進行統計分析之資料型態的寬表。

**表三** 標準化分組後回傳的長表資料型態

|ID|GroupType|(TimeTag)|FirstCaseDate|EndCaseDate|Count|Period|
|--|----|-----|---|---|---|-----|
|病患編碼|標準化分組|事件發生前/後|第一筆資料時間|最後一筆資料時間|個數|第一筆資料與最後一筆資料相隔週期|

取診斷資料中最早診斷的時間為first case date，診斷資料中最後記錄的時間為end case date，並計算其週期（period）內相差的天數，以及週期內共有幾筆診斷紀錄（count）

其中CCS單階層、多階層及PheWAS的分組(IcdDxToCCS, IcdDxToCCSLvl, IcdDxToPheWAS)另可選擇為"組別"或"組別敘述" (`isDescription` = TRUE or FALSE)

舉例來說CCS = 1，其組別敘述為"Tuberculosis"；供使用者選擇呈現方式


###一、CCS 臨床分類軟體
美國Healthcare Cost and Utilization Project（HCUP）發展出一套診斷與處置的臨床分組標準CCS。基於此機制，將分散的診斷碼依照其臨床意義進行單層式或階層式的標準化診斷整合分類，其階層式診斷分類可依使用需求調整分類標準。


單一階層: 較通用的分類

多階層: 將診斷碼分為較精確的分組


**1) CCS單一階層分類**

`IcdDxToCCS` 可取得診斷編碼相對應的 CCS 分類 (CCS category) 及分類之敘述

ICD-9-CM 和 ICD-10-CM 的ccs單一階層一致: 共260種
```r
## ICD to CCS category's description 
CCS_description <- IcdDxToCCS(DxDataFile = sampleDxFile,
                              idColName = ID,
                              icdColName = ICD,        
                              dateColName = Date,
                              icd10usingDate = "2015-10-01",
                              isDescription = TRUE)
head(CCS_description$groupedDT, 5)
#>       Short  ID    ICD       Date   CCS_CATEGORY_DESCRIPTION
#> 1:     Z992  A2  Z992  2020-05-22     Chronic kidney disease
#> 2:     Z992  A5  Z992  2020-01-24     Chronic kidney disease
#> 3:     Z992  A8  Z992  2015-10-27     Chronic kidney disease
#> 4:     Z992 A13  Z992  2020-04-26     Chronic kidney disease
#> 5:     Z992 A13  Z992  2025-02-02     Chronic kidney disease

head(CCS_description$summarised_groupedDT, 5)
#>     ID CCS_CATEGORY_DESCRIPTION firstCaseDate endCaseDate count    period
#> 1:  A0   Chronic kidney disease    2009-07-25  2013-12-20     5 1609 days
#> 2:  A1   Chronic kidney disease    2006-11-29  2014-09-24     5 2856 days
#> 3: A10   Chronic kidney disease    2007-11-04  2012-07-30     5 1730 days
#> 4: A11   Chronic kidney disease    2008-03-09  2011-09-03     5 1273 days
#> 5: A12   Chronic kidney disease    2006-05-14  2015-06-29     5 3333 days

## ICD to CCS category
CCS_category <- IcdDxToCCS(DxDataFile = sampleDxFile, 
                          idColName = ID,         
                          icdColName = ICD,       
                          dateColName = Date, 
                          icd10usingDate = "2015-10-01",
                          isDescription = FALSE)
```

**2) CCS多階層分類**

`IcdDxToCCSLvl` 可取得診斷編碼相對應的 CCS 多階層分類 (Multiple ccs level) 及分類之敘述

ICD-9-CM 共 4個階層 (Level 1~4)

ICD-10-CM 共 2個階層 (Level 1~2)
```r
## ICD to CCS multiple level 2 description
CCSlvl_description <- IcdDxToCCSLvl(DxDataFile = sampleDxFile,
                                    idColName = ID,  
                                    icdColName = ICD,   
                                    dateColName = Date,
                                    icd10usingDate = "2015-10-01",
                                    CCSLevel = 2,
                                    isDescription = TRUE)
head(CCSlvl_description$groupedDT, 5)
#>    Short  ID  ICD       Date                CCS_LVL_2_LABEL
#> 1:  Z992  A2 Z992 2020-05-22 Diseases of the urinary system
#> 2:  Z992  A5 Z992 2020-01-24 Diseases of the urinary system
#> 3:  Z992  A8 Z992 2015-10-27 Diseases of the urinary system
#> 4:  Z992 A13 Z992 2020-04-26 Diseases of the urinary system
#> 5:  Z992 A13 Z992 2025-02-02 Diseases of the urinary system

head(CCSlvl_description$summarised_groupedDT, 5)
#>     ID                CCS_LVL_2_LABEL firstCaseDate endCaseDate count    period
#> 1:  A0 Diseases of the urinary system    2009-07-25  2013-12-20     5 1609 days
#> 2:  A1 Diseases of the urinary system    2006-11-29  2014-09-24     5 2856 days
#> 3: A10 Diseases of the urinary system    2007-11-04  2012-07-30     5 1730 days
#> 4: A11 Diseases of the urinary system    2008-03-09  2011-09-03     5 1273 days
#> 5: A12 Diseases of the urinary system    2006-05-14  2015-06-29     5 3333 days

## ICD to CCS multiple level 3 category
CCSLvl_category <- IcdDxToCCSLvl(DxDataFile = sampleDxFile,
                                    idColName = ID,  
                                    icdColName = ICD,   
                                    dateColName = Date,
                                    icd10usingDate = "2015-10-01",
                                    CCSLevel = 3,
                                    isDescription = FALSE)
```
###二、PheWAS
由 Vanderbilt University Medical Center 開發的 PheWAS 工具，將分散的診斷碼依照其臨床意義進行標準化分組， 共1,866種的PheWAS分類，ICD-9-CM和PheWAS為多對多的配對關係。

最新版本為 version 2 (phecode_icd9_2)，目前只有 ICD-9-CM 供標準化分組
```r
## ICD to PheWAS
PheWAS <- IcdDxToPheWAS(DxDataFile = sampleDxFile,
                         idColName = ID,           
                         icdColName = ICD,     
                         dateColName = Date,
                         icd10usingDate = "2015-10-01",
                         isDescription = FALSE)
PheWAS$groupedDT[7:11,]
#>      ICDD ID   ICD       Date PheCode
#> 1:  585.5 A0  5855 2013-12-20  585.32
#> 2: V45.11 A0 V4511 2012-04-05  585.31
#> 3:  V56.0 A0  V560 2010-03-28  585.31
#> 4:  585.3 A0  5853 2010-10-29  585.33
#> 5:  585.6 A0  5856 2009-07-25  585.32
PheWAS$summarised_groupedDT[7:11,]
#>    ID PheCode firstCaseDate endCaseDate count    period
#> 1: A2  585.32    2011-09-20  2015-01-06     3 1204 days
#> 2: A2  585.31    2015-08-12  2015-08-12     1    0 days
#> 3: A3  585.34    2014-02-24  2014-02-24     1    0 days
#> 4: A3  585.32    2010-11-12  2010-11-12     1    0 days
#> 5: A3     587    2008-07-08  2013-01-31     3 1668 days
```

###三、自定義診斷碼分組

因應臨床研究需求，本套件採多樣的分組方式以維持診斷醫療大數據分析的彈性，提供進階使用者自行定義診斷分組類別及類別項目，使用者可選擇精確比對或是模糊比對的方式訂定篩選的分組類別及類別項目進行診斷碼的分群。

範例如下，使用者欲定義符合慢性腎臟疾病（Chronic kidney disease）的疾病編碼，相關診斷編碼如下：

ICD-9：5851, 5852,..., 5859

ICD-10：N181, N182,..., N189

自定義診斷分組提供兩種分組方法供使用者選擇，將符合條件的診斷編碼分組為心律異常的組別。


**1) IcdDxToCustom**：**精確比對**

使用者須定義精確分組的表格 (groupingTable)，輸入詳細的診斷編碼 (N181, 5853, 5854…)，
進行分組的資料須要完全符合，才會歸類為Cardiac dysrhythmias，另外不符合條件的組別則顯示`NA`。

```r
# groupingTable 
groupingTable <- data.table(group = rep("Chronic kidney disease",6),
                            ICD = c("N181","5853","5854","5855","5856","5859"))

CustomGroup <- IcdDxToCustom(DxDataFile = sampleDxFile,  
                            idColName = ID,         
                            icdColName = ICD,  
                            dateColName = Date,
                            CustomGroupingTable = groupingTable)
CustomGroup$groupedDT[10:14]
#>     ICD ID       Date                  group
#> 1: 5853 A0 2010-10-29 Chronic kidney disease
#> 2: 5856 A0 2009-07-25 Chronic kidney disease
#> 3: 5856 A1 2006-11-29 Chronic kidney disease
#> 4: 5855 A1 2012-06-19 Chronic kidney disease
#> 5: 5855 A1 2013-04-28 Chronic kidney disease

CustomGroup$summarised_groupedDT[1:5]
#>     ID                  group firstCaseDate endCaseDate count    period
#> 1:  A0 Chronic kidney disease    2009-07-25  2013-12-20     3 1609 days
#> 2:  A1 Chronic kidney disease    2006-11-29  2014-09-24     4 2856 days
#> 3: A10 Chronic kidney disease    2007-11-04  2007-11-04     1    0 days
#> 4: A11 Chronic kidney disease    2008-03-09  2010-02-21     2  714 days
#> 5: A12 Chronic kidney disease    2006-05-14  2011-02-25     3 1748 days
```
**2) IcdDxToCustomGrep**：**模糊比對**

使用者須定義模糊分組的表格 (grepTable)，以字串比對之正規表示式 (585* , N18 * …)，當資料開頭為585* (ICD-9-CM) 或是N18 * (ICD-10-CM) 即符合使用者定義之組別條件Cardiac dysrhythmias，另外不符合條件的組別則顯示`NA`。
```r
# grepTable
grepTable <- data.frame(group = "Chronic kidney disease",
                        grepIcd = "^585|^N18",
                        stringsAsFactors = FALSE)

CustomGrepGroup <- IcdDxToCustomGrep(DxDataFile = sampleDxFile, 
                                    idColName = ID,            
                                    icdColName = ICD,   
                                    dateColName = Date,
                                    CustomGroupingTable = grepTable)
CustomGrepGroup$groupedDT[10:14]
#>    ID  ICD       Date                  group
#> 1: A0 5853 2010-10-29 Chronic kidney disease
#> 2: A0 5856 2009-07-25 Chronic kidney disease
#> 3: A1 5856 2006-11-29 Chronic kidney disease
#> 4: A1 5855 2012-06-19 Chronic kidney disease
#> 5: A1 5855 2013-04-28 Chronic kidney disease

CustomGrepGroup$summarised_groupedDT[1:5]
#>     ID                  group firstCaseDate endCaseDate count    period
#> 1:  A0 Chronic kidney disease    2009-07-25  2013-12-20     3 1609 days
#> 2:  A1 Chronic kidney disease    2006-11-29  2014-09-24     4 2856 days
#> 3: A10 Chronic kidney disease    2007-11-04  2007-11-04     1    0 days
#> 4: A11 Chronic kidney disease    2008-03-09  2010-02-21     2  714 days
#> 5: A12 Chronic kidney disease    2006-05-14  2011-02-25     3 1748 days
```
###四、共病症
共病症(Comorbidities)為病患於主診斷之外，其他已存在且會對主診斷疾病產生影響的疾病症狀，共病症分群基於診斷編碼進行標準化分組， 根據不同測量方法對共病症的定義分別介紹之：AHRQ、Charlson及Elixhauser


**1) Elixhauser**

Elixhauser Comorbidity為Dr. Elixhauser與其團隊在1998年提出基於標準ICD診斷碼的共病症分類分組標準，Elixhauser database共病症測量指標為HCUP 發展的共病症資料庫之一

ICD-9-CM 及 ICD-10-CM 的 Elixhauser 共病症種類一致，共 29 種

欲將診斷編碼依照 Elixhauser 共病症分類，在 function `IcdDxToComorbid` 的`comorbidMethod` 輸入 `elix`
```r
ELIX <- IcdDxToComorbid(DxDataFile = sampleDxFile,
                        idColName = ID,           
                        icdColName = ICD,       
                        dateColName = Date,
                        icd10usingDate = "2015-10-01",
                        comorbidMethod = elix)

ELIX$groupedDT[160:164]
#>     Short ID    ICD       Date Comorbidity
#> 1: M06821 D1 M06821 2016-12-06     ANEMDEF
#> 2:  K7291 D1  K7291 2024-04-04     HYPOTHY
#> 3: O99353 D2 O99353 2023-10-23        METS
#> 4: F13230 D2 F13230 2022-09-15        DMCX
#> 5:  C8397 D2  C8397 2019-10-13       LIVER

head(ELIX$summarised_groupedDT, 5)
#>     ID Comorbidity firstCaseDate endCaseDate count    period
#> 1:  A0    RENLFAIL    2009-07-25  2013-12-20     5 1609 days
#> 2:  A1    RENLFAIL    2006-11-29  2014-09-24     5 2856 days
#> 3: A10    RENLFAIL    2007-11-04  2012-07-30     5 1730 days
#> 4: A11    RENLFAIL    2008-03-09  2011-09-03     5 1273 days
#> 5: A12    RENLFAIL    2006-05-14  2015-06-29     5 3333 days
```
**2) AHRQ**

於2017年基於Elixhauser Comorbidity 更進一步設計AHRQ Elixhauser Comorbidity Index，此index為單一的風險評估分數，可用於再入院與死亡的風險評估。

ICD-9-CM及 ICD-10-CM的AHRQ 共病症種類一致，共30種

欲將診斷編碼依照 AHRQ 共病症分類，在 function `IcdDxToComorbid` 的 `comorbidMethod` 輸入 `AHRQ`
```r
AHRQ <- IcdDxToComorbid(DxDataFile = sampleDxFile,
                        idColName = ID,           
                        icdColName = ICD,       
                        dateColName = Date,
                        icd10usingDate = "2015-10-01",
                        comorbidMethod = AHRQ)
AHRQ$groupedDT[160:164]
#>     Short ID    ICD       Date Comorbidity
#> 1: M06821 D1 M06821 2016-12-06   Rheumatic
#> 2:  K7291 D1  K7291 2024-04-04       Liver
#> 3: O99353 D2 O99353 2023-10-23  NeuroOther
#> 4: F13230 D2 F13230 2022-09-15       Drugs
#> 5:  C8397 D2  C8397 2019-10-13    Lymphoma

head(AHRQ$summarised_groupedDT, 5)
#>     ID Comorbidity firstCaseDate endCaseDate count    period
#> 1:  A0       Renal    2009-07-25  2013-12-20     5 1609 days
#> 2:  A1       Renal    2006-11-29  2014-09-24     5 2856 days
#> 3: A10       Renal    2007-11-04  2012-07-30     5 1730 days
#> 4: A11       Renal    2008-03-09  2011-09-03     5 1273 days
#> 5: A12       Renal    2006-05-14  2015-06-29     5 3333 days
```
**3) Charlson**

Charlson database共病症測量指標的是基於Quan的Charlson Comorbidity Index版本，依診斷編碼其相關的共病症做分類

ICD-9-CM 及 ICD-10-CM 的 Charlson 共病症種類一致，共17種

欲將診斷編碼依照 Charlson 共病症分類，在 function `IcdDxToComorbid` 的`comorbidMethod` 輸入 `Charlson`
```r
Charlson <- IcdDxToComorbid(DxDataFile = sampleDxFile,
                        idColName = ID,           
                        icdColName = ICD,       
                        dateColName = Date,
                        icd10usingDate = "2015-10-01",
                        comorbidMethod = charlson)

Charlson$groupedDT[160:164]
#>     Short ID    ICD       Date Comorbidity
#> 1: M06821 D1 M06821 2016-12-06       Rheum
#> 2:  K7291 D1  K7291 2024-04-04        MSLD
#> 3: O99353 D2 O99353 2023-10-23        <NA>
#> 4: F13230 D2 F13230 2022-09-15        <NA>
#> 5:  C8397 D2  C8397 2019-10-13      CANCER

head(Charlson$summarised_groupedDT, 5)
#>     ID Comorbidity firstCaseDate endCaseDate count    period
#> 1:  A0          RD    2009-07-25  2013-12-20     5 1609 days
#> 2:  A1          RD    2006-11-29  2014-09-24     5 2856 days
#> 3: A10          RD    2007-11-04  2012-07-30     5 1730 days
#> 4: A11          RD    2008-03-09  2011-09-03     5 1273 days
#> 5: A11      DIAB_C    2015-12-16  2015-12-16     1    0 days
```

###五、篩選符合條件的個案
將醫療大數據診斷資訊進行標準化處理與整合後，將依據使用者所設立的條件篩選符合條件的個案。篩選個案的功能和疾病世代的概念類似，適用於一般疾病（限制搜尋範圍）或慢性病（沒有限制搜尋範圍）的計算。

為選取符合特定條件之診斷資料，目前有三種條件進行篩選：

1) 	設立篩選條件

    `groupDataType`：設定篩選的分組依據，可用CCS、PheWAS、comorbidity、自定義組別或診斷編碼
    
    `caseCondition`：設定篩選的方式為精確比對或模糊比對
    
2) 	設定搜尋範圍

　　　`INRofDayRange`：限制每筆診斷資料之間的間隔範圍，預設為至少間隔30天至365天時間內的資料
　　

3) 	ICD次數

　　　`caseCount`：符合篩選方式的最小出現次數，預設至少出現兩次

最後回傳符合條件的個案資料如**表四**。

**表四** 選取特定個案診斷紀錄後回傳的資料型態

|ID|Count|FirstCaseDate|EndCaseDate|Period|MostCommonICD|MostCommonICDCount|
|--|--|---|---|--|-----|-----|
|病患編碼|個數|第一筆資料時間|最後一筆資料時間|第一筆資料與最後一筆資料相隔週期| 出現最多次數的診斷編碼|最常出現診斷編碼的次數 |


符合條件的個案將整合為一筆資料，內容包含符合條件的資料總數（count），第一筆診斷資料（first case date）及最後一筆資料時間（end case date）及資料時間相隔週期（period），出現最多次的ICD及次數（most common ICD and most common ICD count）。

符合篩選條件會在欄位`selectedCase`顯示"Selected"，使用者也可自行定義組別名稱 (在argument`selectCaseType`設定)
以第一筆做說明，個案A0符合篩選條件的診斷資料共5筆。其中V420出現三筆，出現次數最高。第一筆診斷日期為"2008-07-08"，最後一筆診斷紀錄為"2014-02-24"，整個診斷紀錄週期為2057天
```r
Case <- selectCases(DxDataFile = sampleDxFile,
                   idColName = ID,           
                   icdColName = ICD,       
                   dateColName = Date,
                   groupDataType = ccslvl2,
                   icd10usingDate = "2015/10/01",
                   caseCondition = "Diseases of the urinary system",
                   caseCount = 1,
                   selectCaseType = "Selected")
head(Case)                   
#>     ID selectedCase count firstCaseDate endCaseDate    period MostCommonICD MostCommonICDCount
#> 1:  A3     Selected     5    2008-07-08  2014-02-24 2057 days          V420                  3
#> 2:  A1     Selected     5    2006-11-29  2014-09-24 2856 days          5855                  2
#> 3: A10     Selected     5    2007-11-04  2012-07-30 1730 days         V5631                  2
#> 4: A12     Selected     5    2006-05-14  2015-06-29 3333 days          5859                  2
#> 5: A13     Selected     5    2006-04-29  2025-02-02 6854 days          5855                  2
#> 6: A15     Selected     5    2007-05-25  2023-05-12 5831 days         V5631                  2  
```
###六、就診紀錄第一筆資料及最後一筆資料
取得病患的就診紀錄第一筆資料及最後一筆資料
```r
admissionDate <- patientRecordDate(DxDataFile = sampleDxFile,
                                   idColName = ID,
                                   icdColName = ICD,
                                   dateColName = Date)
head(admissionDate)                                  
#>     ID firstRecordDate endRecordDate
#> 1:  D6      2005-10-09    2025-01-05
#> 2: A12      2006-01-12    2022-06-12
#> 3:  D1      2006-02-12    2024-04-04
#> 4: A13      2006-04-29    2025-02-02
#> 5:  A9      2006-06-30    2023-12-10
#> 6:  D2      2006-09-01    2025-08-11
```
###七、以事件區分指標日期（index date）區分事件前後的醫療紀錄
醫學研究常需要觀察特定事件發生前後的改變，因此需要一個指標時間（index date）來記錄事件的發生。TimeTag欄位可顯示此紀錄為事件前或是事件後（before and after），使用者可依此欄位選擇事件發生前／後的資料。

另外本套見也提供週期（window）計算功能，預設週期長度為30天。

舉例來說，指標日期根據不同個案定義，個案A0之指標日期為2009/07/25。

個案A0的第一筆診斷資料時間為2009-07-25視為指標日期之後發生的紀錄，因此TimeTag為A (after)。兩筆資料間隔天數為0天，故為第1個週期。

個案A0的第二筆診斷資料時間為2010-03-28視為指標日期後的紀錄，因此TimeTag為A。資料間隔天數為246天，故為第9個週期。

週期長度 (`windowGap`) 和指標日期 (`indexDateTable`) 依使用者需求定義。

```r
indexDateTable <- data.frame(ID = c("A0","B0","C0","D0"),
                             indexDate = c("2009-07-25", "2015-12-26",
                                           "2015-12-05", "2017-01-29"),
                             stringsAsFactors = FALSE)
Data <- splitDataByDate(DxDataFile = sampleDxFile,
                        idColName = ID,
                        icdColName = ICD,
                        dateColName = Date,
                        indexDateFile = indexDateTable,
                        windowGap = 30) 
head(Data, 5)
#>     ID    ICD       Date  indexDate timeTag window
#>  1: A0   5856 2009-07-25 2009-07-25       A      1
#>  2: A0   V560 2010-03-28 2009-07-25       A      9
#>  3: A0   5853 2010-10-29 2009-07-25       A     16
#>  4: A0  V4511 2012-04-05 2009-07-25       A     33
#>  5: A0   5855 2013-12-20 2009-07-25       A     54
```
### 八. 疾病世代
在診斷紀錄整合機制方面，Dr. Ryan提出疾病世代（Condition era）概念整合處理連續性的醫療行為，
將分散的醫療紀錄整合為單一病程發展紀錄，以利後續醫療大數據分析使用。

疾病世代的概念是針對疾病定義持續期（gap）長度，若診斷與診斷間間隔小於gap，則兩個診斷視為同一個疾病世代。

疾病世代的診斷分類可選擇診斷編碼、CCS、Phecode、comorbidity和自定義分類組別，計算病患之疾病世代，其持續期長度預設值為30天。

以範例的第一個結果做說明：個案A0被分組到CCS "158"共有5筆資料，其中第一筆診斷日期為"2009-07-25"，最後一筆診斷紀錄為"2013-12-20"，整個週期相差天數為1609天，共五個era (意指五筆診斷紀錄彼此相差天數都大於gap長度)。
```r
Era <- getConditionEra(DxDataFile = sampleDxFile,
                       idColName = ID,
                       icdColName = ICD,
                       dateColName = Date,
                       icd10usingDate = "2015-10-01", 
                       gapDate = 30,
                       groupDataType = ccs,
                       isDescription = FALSE)
head(Era)                       
#>     ID CCS_CATEGORY firstCaseDate endCaseDate count era    period
#> 1:  A0          158    2009-07-25  2013-12-20     5   5 1609 days
#> 2:  A1          158    2006-11-29  2014-09-24     5   5 2856 days
#> 3: A10          158    2007-11-04  2012-07-30     5   4 1730 days
#> 4: A11          158    2008-03-09  2011-09-03     5   4 1273 days
#> 5: A12          158    2006-05-14  2015-06-29     5   5 3333 days
#> 6: A13          158    2006-04-29  2025-02-02     5   5 6854 days
```
## III. EDA preparation
診斷碼整合分組後，為能進行後續的探索性資料分析，提供資料型態轉換的功能，以便進行統計分析之資料型態的寬表。

寬表提供兩種表示方式如**表五、表六**，以二分法（binary）或是數量（numeric）的方式呈現。當病患沒有相關的疾病診斷，二分法的表示法為false，反之，不論有幾筆疾病診斷紀錄，二分法的表示法為true。數量表示法則計算該病患在相關疾病的分組上有幾筆疾病診斷資料

以下範例以共病症 Elixhauser為範例進行兩種表示法進行回傳資料型態的示範
```r
groupedDataLongToWide(DxDataFile = sampleDxFile, 
                      idColName = ID,    
                      icdColName = ICD,   
                      dateColName = Date,
                      icd10usingDate = "2015-10-01",
                      groupDataType = Elix,
                      numericOrBinary = B)
```
**表五** 標準化分組結果轉為二分法（binary）寬表

|ID|ANEMDEF|CHRNLUNG|RENLFAIL|	….. |
|--|----|-----|----|------|
|A0|FALSE|FALSE|TRUE| …..|	
|A1|FALSE|FALSE|TRUE|	…..|
|A10|FALSE|FALSE|TRUE|	…..|
```r
groupedDataLongToWide(DxDataFile = sampleDxFile, 
                      idColName = ID,    
                      icdColName = ICD,   
                      dateColName = Date,
                      icd10usingDate = "2015-10-01",
                      groupDataType = ELix,
                      numericOrBinary = N)
```
**表六** 標準化分組結果轉為數量（numeric）寬表

|ID|ANEMDEF|CHRNLUNG|RENLFAIL|	….. |
|--|----|-----|----|-------|
|A0|0|0|5| …..|	
|A1|0|0|5|	…..|
|A10|0|0|5|	…..|


## IV. Visualization

第四部份視覺化：套件將前述功能之結果整合，以圖表形式呈現

### Pareto plot：錯誤編碼之柏拉圖圖表
進行第一階段 - 診斷編碼格式統一 (Code standarization) 時，將資料中的錯誤編碼訊息列表其數量轉換成圖表

使用者可選擇只看格式錯誤 (wrong format) 或是版本分類錯誤 (wrong version) 或不分類顯示全部的錯誤編碼

以柏拉圖圖表(Pareto plot)的方式呈現，使用者可得知錯誤編碼的種類及出現比例，並依照錯誤數量依序排名。使用者可選擇顯示前幾名 (Top N) 的錯誤編碼，預設顯示前10名的錯誤編碼。

如範例，欲觀察前十名的錯誤編碼種類及分布比例，第11名以後的錯誤編碼設為＂others＂(使用者可選擇是否顯示others的資訊)

```r
error <- IcdDxDecimalToShort(DxDataFile = sampleDxFile,
                            icdColName = ICD,
                            dateColName = Date,
                            icd10usingDate = "2015/10/01")
plot_errorICD(errorFile = error$Error,
              ICDVersion = all,
              wrongICDType = all,
              groupICD = FALSE,
              Others = TRUE)
```
![pareto plot of error ICD](https://raw.githubusercontent.com/DHLab-CGU/emr/master/docs/reference/plot_errorICD-2.png)

上圖顯示前10名錯誤的診斷編碼，其餘名次的錯誤編碼則分類至"Others"

第一名的錯誤**A0.11**共有20筆，佔全部錯誤18.35%(20/109)
```r
#> $ICD
#>        ICD count  CumCountPerc IcdVersionInFile     WrongType Suggestion
#>  1:  A0.11    20        18.35%           ICD 10  Wrong format           
#>  2:  V27.0    18        34.86%           ICD 10 Wrong version           
#>  3:   E114     8        42.20%           ICD 10  Wrong format           
#>  4: A01.05     8        49.54%            ICD 9 Wrong version           
#>  5:  42761     7        55.96%           ICD 10 Wrong version           
#>  6:  Z9.90     6        61.47%           ICD 10  Wrong format           
#>  7:    F42     6        66.97%           ICD 10  Wrong format           
#>  8:  V24.1     6        72.48%           ICD 10 Wrong version           
#>  9:  A0105     5        77.06%            ICD 9 Wrong version           
#> 10:    001     5        81.65%            ICD 9  Wrong format       0019
#> 11: Others    20       100.00%            ICD 9  Wrong format           
```
另外使用者可選擇將**ICD-9**依照章節**分組**

ICD-9共19章節疾病分類：

　001-139: 傳染病或寄生蟲相關疾病

　140-239: 腫瘤相關疾病
　
　
　...等。

`plot_errorICD`依照編碼開頭分類，大致分為12組: 0, 1, 2,..., 9, V and E

如範例，欲觀察**前三名**的錯誤編碼種類及分布比例，第4名以後的錯誤編碼設為＂others＂

並選擇上述功能**分組**

```r
plot_errorICD(errorFile = error$Error,
              ICDVersion = 9,
              wrongICDType = all,
              groupICD = TRUE,
              Others = TRUE,
              TopN = 3)
```
![pareto plot of error ICD9 (grouped)](https://raw.githubusercontent.com/DHLab-CGU/emr/master/docs/reference/plot_errorICD-1.png)
由下表格得知第一名的錯誤編碼為**A01.05**佔組別A共61.54%，總共有13筆錯誤，佔全部的錯誤41.94%的比例
```r
#> $ICD
#>    ICDGroup groupCount CumCountPerc  MostICDInGroup  ICDPercInGroup  IcdVersionInFile
#> 1:        A         13       41.94%          A01.05          61.54%             ICD 9           
#> 2:        7          9       70.97%           75.52          44.44%             ICD 9           
#> 3:        0          5        87.1%             001         100.00%             ICD 9
#> 4:   Others          4         100%           E03.0         100.00%             ICD 9           
```
### histogram plot：標準化分組之長條圖表
進行第二和第三階段 - 資料整合 (Data integration) 並轉換為探索性長表資料 (EDA preparation)，此功能整合長表資料圖形化，以便觀察診斷資料在各分群（如CCS、 comorbidity）的分布情形及數量。

使用者可選擇顯示前幾名的分組資料(Top N)，且每個分群至少有一定比例的病患 (limitPercentage)，
舉例來說，假設使用者的資料共1000個病患，每種組別至少要有10個病患（1%）。

預設顯示前十名，限制比例為1% (0.01)。

範例使用步驟如下：

1) 將資料以共病症Elixhauser做標準化分組並轉成寬表，以二分法(binary)的形式呈現

2) 設定作圖標準：顯示前幾名組別、限制比例

```r
groupedDataWide <- groupedDataLongToWide(sampleDxFile,
                                         idColName = ID,
                                         icdColName = ICD,
                                         dateColName = Date,
                                         icd10usingDate = "2015-10-01",
                                         groupDataType = elix,
                                         numericOrBinary = B)
plot1 <- plot_groupedData(groupedDataWide = groupedDataWide,
                          TopN = 10,
                          limitPercentage = 0.01)
plot1$graph
```
![pareto plot of error ICD9 (grouped)](https://raw.githubusercontent.com/DHLab-CGU/emr/master/docs/reference/plot_groupedData-1.png)
下表格為有符合條件設定的共病症前十名，每組分別有多少人，且該共病症在資料中的比例

本範例共有38個病患，以第一組為例，共有24人被分為 RENLFAIL 共病症，比例為63.16%(24/38)
```r
plot1$sigCate
#>     category count catePerc
#>  1: RENLFAIL    24   63.16%
#>  2:  ANEMDEF     5   13.16%
#>  3: PULMCIRC     5   13.16%
#>  4:    LIVER     4   10.53%
#>  5:    PSYCH     3    7.89%
#>  6:     DRUG     2    5.26%
#>  7:     METS     2    5.26%
#>  8:    NEURO     2    5.26%
#>  9:     PARA     2    5.26%
#> 10:    TUMOR     2    5.26%
```
若資料有進行病患分組case/control，於每個類別 (如CCS、comorbidity)將進行兩組 (case and control)的卡方獨立性檢定，圖表將顯示**達統計上顯著差異**的分組類別。

若樣本數過小以致不適用卡方檢定時，則採用費雪爾精確檢定 (Fisher’s Exact Test)

預設顯示前十名的類別，且每群種類的病患在兩組的比率至少有一組達1%，舉例來說，假設case和control組各500人，在某特定組別至少有一組的人數有5個病患 (1%)。

顯著差異p value預設門檻為0.05

範例使用步驟如下：

1) 定義case/control組，採CCS多階層的標準化分組，在CCS level 2被分組為"Diseases of the urinary system" 視為case組，詳細設定條件請看範例

2) 將資料以共病症Elixhauser做標準化分組並轉成寬表，以二分法(binary)的形式呈現

3) 設定作圖標準：顯示前幾名組別、限制比例、p value

```r
selectedCaseFile <- selectCases(DxDataFile = sampleDxFile,
                                idColName = ID,
                           　　 icdColName = ICD,
                            　　dateColName = Date,
                                icd10usingDate = "2015/10/01",
                                groupDataType = ccslvl2,
                                caseCondition = "Diseases of the urinary system",
                                caseCount = 1)
                                
groupedDataWide <- groupedDataLongToWide(sampleDxFile, ID, ICD, Date,
                                         icd10usingDate = "2015-10-01",
                                         groupDataType = elix,
                                         numericOrBinary = B,
                                         selectedCaseFile = selectedCaseFile)
plot2 <- plot_groupedData(groupedDataWide = groupedDataWide,
                          TopN = 10,
                          limitPercentage = 0.01,
                          pvalue = 0.05)
plot2$graph
```
![pareto plot of error ICD9 (grouped)](https://raw.githubusercontent.com/DHLab-CGU/emr/master/docs/reference/plot_groupedData-2.png)
下表格為在selected/nonSelected兩組間達顯著差異的共病症組別RENLFAIL

在selected組佔了79.17% (19/24)，在nonSelected組佔了35.71% (5/14)

```r
plot2$sigCate
#>    category       group count catePerc
#> 1: RENLFAIL    Selected    19    79.17
#> 2: RENLFAIL nonSelected     5    35.71

```

## Reference

### I. Code standarization

ICD-9-CM code (2014): https://www.cms.gov/Medicare/Coding/ICD9ProviderDiagnosticCodes/codes.html

ICD-10-CM code (2019): https://www.cms.gov/Medicare/Coding/ICD10/2019-ICD-10-CM.html

https://www.cms.gov/Medicare/Coding/ICD10/2019-ICD-10-CM.html

https://www.findacode.com/search/search.php

https://www.cms.gov/Medicare/Quality-Initiatives-Patient-Assessment-Instruments/HospitalQualityInits/Downloads/HospitalAppendix_F.pdf

### II. Data integration

本套件使用之CCS版本依照HCUP提供之最新版本進行年度的更新，目前ICD-9-CM與ICD-10-CM的CCS定義版本分別為2015年及2019年版。

Phecode依照PheWAS Resources網站 進行更新，目前版本為第二版（2015年）。

Elixhauser共病症依照HCUP提供之版本進行更新，目前ICD-9-CM與ICD-10的Elixhauser共病症定義版本分別為2015年及2019年版。

**CCS (Clinical Classifications Software)**

ICD-9-CM (2015): https://www.hcup-us.ahrq.gov/toolssoftware/ccs/Single_Level_CCS_2015.zip

https://www.hcup-us.ahrq.gov/toolssoftware/ccs/Multi_Level_CCS_2015.zip

ICD-10-CM (2019): https://www.hcup-us.ahrq.gov/toolssoftware/ccs10/ccs_dx_icd10cm_2019_1.zip

**Phecode**

ICD-9-Phecode (version 1.2, 2015): https://phewascatalog.org/phecodes

**Comorbidities**

ICD-9-AHRQ (2012-2015): https://www.hcup-us.ahrq.gov/toolssoftware/comorbidity/comorbidity.jsp#references

ICD-10-AHRQ (2019): https://www.hcup-us.ahrq.gov/toolssoftware/comorbidityicd10/comformat_icd10cm_2019_1.txt

ICD-9-Charlson: http://mchp-appserv.cpe.umanitoba.ca/Upload/SAS/ICD9_E_Charlson.sas.txt

ICD-10-Charlson: http://mchp-appserv.cpe.umanitoba.ca/Upload/SAS/ICD10_Charlson.sas.txt

ICD-9-Elixhauser (2012-2015): https://www.hcup-us.ahrq.gov/toolssoftware/comorbidity/comorbidity.jsp#references

ICD-10-Elixhauser (2019): https://www.hcup-us.ahrq.gov/toolssoftware/comorbidityicd10/comformat_icd10cm_2019_1.txt
