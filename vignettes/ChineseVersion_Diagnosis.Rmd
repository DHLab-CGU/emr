---
title: "Get Started: Chinese Version-Diagnosis"

author: "Hsiang-Ju, Chiu"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Chinese Version}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
devtools::install_github("DHLab-CGU/emr")
library(emr)

DxDataFile <- data.frame(ID = c("A", "A", "B", "B"),
                         ICD = c("40201", "42577", "I350", "K289"),
                         Date = as.Date(c("2013-03-31", "2013-01-29", "2016-03-10", "2016-03-10")),
                         stringsAsFactors = FALSE)
```
# 診斷前處理與整合方法
```
cat(utils::packageDescription("emr")$Description)
```
### ICD-CM-CODE 格式對照
分別產生 ICD-9-CM and ICD-10-CM 的兩種格式的表格: Decimal 和 Short

供後續 ICD 格式轉換的功能使用 (`IcdDxDecimaltoShort 和 IcdDxShortToDecimal`) 

ICD-9-CM
```
icd9 <- ccsDxICD9$ICD
ICD9DxwithTwoFormat <- ICD9DxGenerateDecimalFormat(icd9)

icd9_Short <- ICD9DxwithTwoFormat$Short[1:10]
# c("E9500", "E9501", "E9502", "E9503", "E9504", "E9505", "E9506", "E9507", "E9508", "E9509")
icd9_Decimal <- ICD9DxwithTwoFormat$Decimal[1:10]
# c("E950.0", "E950.1", "E950.2", "E950.3", "E950.4", "E950.5", "E950.6", "E950.7", "E950.8", "E950.9")
```
ICD-10-CM
```
icd10 <- ccsDxICD10$ICD
ICD10DxwithTwoFormat <- ICD10DxGenerateDecimalFormat(icd10)

icd10_Short <- ICD10DxwithTwoFormat$Short[1:10]
# c("A150", "A154", "A155", "A156", "A157", "A158", "A159", "A170", "A171", "A1781")
icd10_Decimal <- ICD10DxwithTwoFormat$Decimal[1:10]
# c("A15.0", "A15.4", "A15.5", "A15.6", "A15.7", "A15.8", "A15.9", "A17.0", "A17.1", "A17.81")
```
### ICD-CM code 格式轉換
ICD-9-CM and ICD-10-CM code 兩種格式的轉換: Short <-> Decimal

進行後續分組功能之前, 根據使用者使用的 ICD 格式進行格式的統一化, 分別兩種功能可以將 ICD 統一轉換為 Short 或 Decimal 的格式

將 ICD-CM code 的格式統一轉成 Decimal
```
# ICD-9
IcdDxShortToDecimal(icd9_Short)$Decimal
# c("E950.0", "E950.1", "E950.2", "E950.3", "E950.4", "E950.5", "E950.6", "E950.7", "E950.8", "E950.9")

# ICD-10
IcdDxShortToDecimal(icd10_Short)$Decimal
# c("A15.0", "A15.4", "A15.5", "A15.6", "A15.7", "A15.8", "A15.9", "A17.0", "A17.1", "A17.81")
```
將 ICD-CM code 的格式統一轉成 Short
```
# ICD-9
IcdDxDecimaltoShort(icd9_Decimal)$Short
# c("E9500", "E9501", "E9502", "E9503", "E9504", "E9505", "E9506", "E9507", "E9508", "E9509")

# ICD-10
IcdDxDecimaltoShort(icd10_Decimal)$Short
# c("A150", "A154", "A155", "A156", "A157", "A158", "A159", "A170", "A171", "A1781")
```

## ICD-CM-code 整合分類
ICD-CM-code 依照不同的分類標準分類: 將分散的 ICD-9-CM 及 ICD-10-CM 的診斷碼依照其臨床上意義相似的歸併整合為較大的群組, 標準化的分類以便於後續的整合統計分析使用

目前分類標準: CCS, phecode, Comorbidity,以及自定義診斷碼分組, 以下將分別介紹之

###一、臨床分類軟體
係以美國醫療照護政策研究品質局（AHRQ）為提供健康政策研究而所發展之「臨床分類軟體」(Clinical Classifications Software, CCS)。 CCS 分為單一階層及多階層的分群, 其階層是診斷分類可依使用需求調整分類標準

單一階層: 較通用的分類

多階層: 將診斷碼分為較精確的分組

目前 ICD-9-CM 的 CCS 版本為 2015 , ICD-10-CM 的 CCS 版本為 2018

####1) 單一階層分類
`IcdDxToCCS` 可取得 ICD-9-CM 及 ICD-10-CM 相對應的 CCS 分類(CCS Category)及分類之敘述

ICD-9-CM 和 ICD-10-CM 的ccs單一階層一致: 共260種
```
## ICD to CCS category
IcdDxToCCS (DxDataFile, ID, ICD, Date, "2016-01-01", FALSE)
# "99"  NA    "96"  "139"

## ICD to CCS description
IcdDxToCCS (DxDataFile, ID, ICD, Date, "2016-01-01", TRUE)
# "Hypertension with complications and secondary hypertension" NA  
# "Heart valve disorders"                                      "Gastroduodenal ulcer (except hemorrhage)" 
```
當 CCS 分類結果為 `NA` , 會出現 `warning Message` , 顯示為NA有兩種方向

1) 可能是 ICD code 並未符合格式: 顯示wrong Format
 
2) 有其他的原因需要進行檢查確認: 顯示warning ICD
 
以範例為例, `42577` 為錯誤的 ICD-9-CM 之格式才會出現 `NA` (wrong format)

####2) 多階層分類
`IcdDxToCCSLvl` 可取得 ICD-9-CM 及 ICD-10-CM 相對應的 CCS 多階層分類(Multiple ccs level)及分類之敘述

ICD-9-CM 共 4個階層 (Level 1~4)

ICD-10-CM 共 2個階層 (Level 1~2)
```
## ICD to CCS multiple level 1
IcdDxToCCSLvl(DxDataFile, ID, ICD, Date, "2016-01-01", 1, FALSE)
# "7" NA  "7" "9"

## ICD to CCS multiple level 3
IcdDxToCCSLvl(DxDataFile, ID, ICD, Date, "2016-01-01", 3, FALSE)
# "7.1.2" NA      NA      NA    
```

當 CCS 多階層分類結果為 `NA` , 會出現 `warning Message` , 可能是 ICD code 並未符合格式或其他原因; ICD-10-CM 的多階層為 1~2, 若篩選階層3或4,則 ICD-10-CM 的分類會出現 `NA`

以範例為例:

1) 篩選level 1: `42577` 為錯誤的ICD-9-CM之格式才會出現 `NA`

2) 篩選level 3: `42577` 為錯誤的ICD-9-CM之格式才會出現 `NA` , ICD-10-CM 的分類為 `NA` (ICD-10-CM 的多階層為 1~2)

###二、Phecode
由 Vanderbilt University Medical Center 開發的 PheWAS 工具中, 用來將 ICD-CM code 做整併分類,其分類稱為 phecode

phecode分組沒有階層性, 其特色在於各分組有其對應的控制組定義, 因此控制組的選擇會排除所有跟病例組相關疾病, 完整的控制組定義使得利用醫療大數據執行病例對照研究 (case-control study)更為全面

最新版本為 version 2 (phecode_icd9_2), 目前只有 ICD-9-CM 供轉換分類
```
## ICD to Phecode
IcdDxToPhecode(DxDataFile, ID, ICD, Date, "2016-01-01", FALSE)
# "401.21" NA       NA       NA   
```
當 Phecode 分類結果為 `NA` , 會出現 `warning Message` , 可能是 ICD code 並未符合格式或其他原因; 輸入ICD-10-CM code也會出現 `NA`

###三、自定義診斷碼分組

因應臨床研究需求, 使用者可自行定義診斷分組類別及類別項目: IcdDxToCustomGrep

範例如下, 欲找出符合高血壓及低血壓分類的 ICD code , 給予其對應的表格, 則會回傳有符合的分組, 未符合則回傳 `NA`
```
icdFile <- data.frame(ICD = c("I95.0", "I952", "I110", "01091"), stringsAsFactors = FALSE)
```
目前提供兩種方法:

 1) `IcdDxToCustom`: 使用`窮舉法`的方式找出符合的ICD
```{r}
# groupingTable 
data.frame(Group = c("Hypotension","Hypotension","Hypotension", "Hypertension", "Hypertension"),
           ICD = c("I95.0","I951","I952","I110","I11.9"),
           stringsAsFactors = FALSE)
```
```
IcdDxToCustom(icdFile, groupingTable)
#  "Hypotension"  "Hypotension"  "Hypertension" NA 
```
 2) `IcdDxToCustomGrep`: 選擇`ICD開頭`有符合做為篩選的條件
```{r}
# grepTable
data.frame(Group = c("Hypotension", "Hypertension"),
           grep_pattern = c("^I95|^I952", "^I11"),
           stringsAsFactors = FALSE)
```
```
IcdDxToCustomGrep(icdFile, grepTable)
# "Hypotension"  "Hypotension"  "Hypertension" NA  
```
###四、共病症
共病症(Comorbidities)為病患於主診斷之外, 其他已存在, 且會對主診斷疾病產生影響的疾病症狀

共病症分群基於ICD診斷碼進行標準化分組, 根據不同測量方法對共病症的定義分別介紹之: AHRQ, Charlson及Elixhauser

#### 1) AHRQ
目前使用 AHRQ 共病症測量指標的data frame是基於`icd package` (`icd9_map_ahrq 及 icd10_map_ahrq`), 使ICD code 依其相關的共病症做分類

ICD-9-CM及 ICD-10-CM的AHRQ 共病症種類一致, 共30種

 ICD-9
```
# convert icd9_map_ahrq (list) to icd9_ahrq (Df)
icd9_ahrq$Comorbidity %>% unique () 
```
 ICD-10
```
# convert icd10_map_ahrq (list) to icd10_ahrq (Df)
icd10_ahrq$Comorbidity %>% unique
```
欲將 ICD 依照 AHRQ 共病症分類, 在 function `IcdDxToComorbid` 的 `comorbidMethod` 輸入 `AHRQ`

```
IcdDxToComorbid(DxDataFile, ID, ICD, Date, "2016-01-01", ahrq, N, TRUE)
```
#### 2) Charlson
目前使用 Charlson 共病症測量指標的 data frame 是基於`icd package` (`icd9_map_charlson 及 icd10_map_charlson`), 使 ICD code 依其相關的共病症做分類

ICD-9-CM 及 ICD-10-CM 的 Charlson 共病症種類一致, 共17種

 ICD-9
```
# convert icd9_map_charlson (list) to icd9_charlson (Df)
icd9_charlson$Comorbidity %>% unique
```
 ICD-10
```
# convert icd10_map_charlson (list) to icd10_charlson (Df)
icd10_charlson$Comorbidity %>% unique
```
欲將 ICD 依照 Charlson 共病症分類, 在 function `IcdDxToComorbid` 的`comorbidMethod` 輸入 `Charlson`

```
IcdDxToComorbid(DxDataFile, ID, ICD, Date, "2016-01-01", charlson, B, TRUE)
```
#### 3) Elixhauser
Elixhauser database共病症測量指標為HCUP (Healthcare Cost and Utilization Project)發展的共病症資料庫之一, 使 ICD code 依其相關的共病症做分類

ICD-9-CM 及 ICD-10-CM 的 Elixhauser 共病症種類一致, 共 29 種

 ICD-9-Elixhauser: 版本為3.7 (ICD-9-CM codes October 1, 2011)
```
icd9_elix$Comorbidity %>% unique
```
 ICD-10-Elixhauser: 版本為2019.1  (FY2019 ICD-10-CM codes) 
```
icd10_elix$Comorbidity %>% unique
```
欲將 ICD 依照 Charlson 共病症分類, 在 function `IcdDxToComorbid` 的`comorbidMethod` 輸入 `elix`
```
IcdDxToComorbid(DxDataFile, ID, ICD, Date, "2016-01-01", elix, N, TRUE)
```
##篩選符合條件的個案數

用以篩選符合特定條件之個案: Select Cases

篩選條件如範例:

1) ICD code `^I0`開頭之個案 (I070,I071,I072...) 

2) 限定至少出現次數為`2`

3) 搜尋範圍:至少間隔一個月並小於一年的時間內 (預設的時間範圍)

回傳的資料為符合條件的個案

```
selectCases_Example <- data.frame(ID = c("A", "A", "A", "A"),
                         ICD = c("I072","I071", "I072", "I071"),
                         Date = as.Date(c("2016-03-31", "2016-01-29", "2016-02-10", "2018-03-10")),
                         stringsAsFactors = FALSE)
selectCases("^I0", selectCases_Example, ID, ICD, Date, "2016-01-01", 2)
```
## 疾病世代
針對分散的醫療紀錄整合機制, Dr.Ryan 提出疾病世代 (Condition Era) 的概念, 用以整合處理連續性的醫療行為, 將分散的醫療紀錄整合為單一病程發展紀錄

疾病世代的概念是針對疾病定義持續期 (GapDate) 長度, 若診斷與診斷間間隔小於GapDate, 則兩個診斷視為同一個疾病世代

依據 CCS 或 ICD 作為診斷的分類, 計算病患之疾病世代, 其持續期長度預設值為30天
```
getConditionEra(DxDataFile, ID, ICD, Date, "2016-01-01", 30, ccs, FALSE)
getConditionEra(DxDataFile, ID, ICD, Date, "2016-01-01", 30, ICD, FALSE)
```
## 參考資料

### ICD 格式: Short 和 Decimal

https://www.findacode.com/search/search.php

https://www.cms.gov/Medicare/Quality-Initiatives-Patient-Assessment-Instruments/HospitalQualityInits/Downloads/HospitalAppendix_F.pdf

### ICD 格式轉換功能 (`IcdDxDecimaltoShort 和 IcdDxShortToDecimal`)

https://www.findacode.com/search/search.php

https://www.cms.gov/Medicare/Quality-Initiatives-Patient-Assessment-Instruments/HospitalQualityInits/Downloads/HospitalAppendix_F.pdf

### 臨床分類軟體 (Clinical Classifications Software, CCS)

ICD-9-CM (2015): https://www.hcup-us.ahrq.gov/toolssoftware/ccs/Single_Level_CCS_2015.zip

https://www.hcup-us.ahrq.gov/toolssoftware/ccs/Multi_Level_CCS_2015.zip

ICD-10-CM (2019): https://www.hcup-us.ahrq.gov/toolssoftware/ccs10/ccs_dx_icd10cm_2019_1.zip

### Phecode

ICD-9-Phecode (version 1.2, 2015): https://phewascatalog.org/phecodes

### Comorbidities 共病症

#### AHRQ

#### Charlson

#### Elixhauser

ICD-9-Elixhauser (2012-2015): https://www.hcup-us.ahrq.gov/toolssoftware/comorbidity/comorbidity.jsp#references

ICD-10-Elixhauser (2019): https://www.hcup-us.ahrq.gov/toolssoftware/comorbidityicd10/comformat_icd10cm_2019_1.txt
