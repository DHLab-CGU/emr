---
title: "Get Started: Chinese Version-Diagnosis"

author: "Hsiang-Ju, Chiu"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Chinese Version}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
devtools::install_github("DHLab-CGU/emr")
library(emr)

```

# I. 診斷前處理與整合方法

```
cat(utils::packageDescription("emr")$Description)
```
### ICD-CM-CODE 格式對照

本套件將CMS所提供的ICD編碼視為ICD編碼的標準依據，並依照CMS (Centers for Medicare & Medicaid Services)訂定的ICD編碼規則，分別產生 ICD-9-CM and ICD-10-CM 的兩種格式的表格: Decimal

供後續 ICD 格式轉換的功能使用 (`IcdDxDecimalToShort 和 IcdDxShortToDecimal`) 

ICD-9-CM
```
icd9_Short <- dxICD9$ICD
ICD9DxwithTwoFormat <- ICD9DxGenerateDecimalFormat(icd9)

icd9_Short <- ICD9DxwithTwoFormat$Short[1:10]
# c("E9500", "E9501", "E9502", "E9503", "E9504", "E9505", "E9506", "E9507", "E9508", "E9509")
icd9_Decimal <- ICD9DxwithTwoFormat$Decimal[1:10]
# c("E950.0", "E950.1", "E950.2", "E950.3", "E950.4", "E950.5", "E950.6", "E950.7", "E950.8", "E950.9")
```
ICD-10-CM
```
icd10 <- dxICD10$ICD
ICD10DxwithTwoFormat <- ICD10DxGenerateDecimalFormat(icd10)

icd10_Short <- ICD10DxwithTwoFormat$Short[1:10]
# c("A150", "A154", "A155", "A156", "A157", "A158", "A159", "A170", "A171", "A1781")
icd10_Decimal <- ICD10DxwithTwoFormat$Decimal[1:10]
# c("A15.0", "A15.4", "A15.5", "A15.6", "A15.7", "A15.8", "A15.9", "A17.0", "A17.1", "A17.81")
```
### ICD-CM code 格式轉換

**ICD-9-CM and ICD-10-CM code兩種格式的轉換: Short <-> Decimal**

進行後續標準化分組功能之前，將診斷紀錄轉換為有臨床意義的疾病分組之前，依據CCS（Clinical Classifications Software）、共病症（Comorbidity）及PheWAS編碼的分組表中ICD診斷碼格式如**表一**，將醫療大數據中的ICD診斷編碼進行編碼格式的轉換，以便後續ICD編碼標準化分群。

雖然CMS所發佈的各項標準使用short格式的ICD編碼，但在診斷碼的紀錄有兩種格式（short及decimal format）可使用，因此需要再進行標準化分組前，將ICD轉換為單一格式

表一 標準化分組之ICD格式

|   |ICD format|
|--------|----|
|Clinical Classifications Software|short format|
|Comorbidity |short format|
|Phecode|decimal format|

為在疾病分組時區別診斷編碼ICD-9-CM與ICD-10-CM，本套件依據診斷日期區分所使用的ICD版本，其時間切割點可依使用者需求設定，如使用者分析台灣的醫療資料，此日期可設定為2016年1月1日

如使用者分析的是美國的醫療資料，則可將日期設定為2015年10月1號。

以下範例皆以`sampleDxFile`作為範例, 區分ICD-9/ICD-10-CM code的使用日期為: 2015年10月1號

**將 ICD-CM code 的格式統一轉成 Decimal**
```
# Short to decimal
decimal <- IcdDxShortToDecimal(sampleDxFile, ICD,Date, "2015/10/01")$ICD
head(decimal)
# c("553.3", "553.3", "553.20", "553.20", "553.3", "K44.9")

```
**將 ICD-CM code 的格式統一轉成 Short**
```
# Decimal to short
short <- IcdDxDecimalToShort(sampleDxFile, ICD,Date, "2015/10/01")$ICD
head(short)
# c("5533", "5533", "55320", "55320", "5533", "K449")

```
**Warning message**

當ICD編碼發生轉換錯誤時，會提供warning message提醒使用者**格式錯誤 (Wrong format)**或是**版本分類錯誤 (Wrong version)**， 避免輸入的ICD編碼錯誤而影響後續臨床疾病分組錯誤或是無法分組的情形。

以下為判斷ICD編碼錯誤之流程圖，將以short 轉為 decimal 作為範例

![warning message](https://raw.githubusercontent.com/amamagg/image/master/msg4.jpg)

1)將資料依照格式分為short及decimal兩部分

2-1)short的組別依照ICD-9及ICD-10分組進行**第一次**格式轉換

ICD-9: C, E

ICD-10: A

2-2)decimal的組別依照ICD-9及ICD-10分組進行**第一次**確認格式正確性

ICD-9: B

ICD-10: D

3)第二步驟結束後，若有NA的個案將挑出來 (D, E)，進行**第二次**的格式轉換和確認正確性。若結果為`NA`．則表示該ICD編碼錯誤；反之結果`不是NA`，則表示該ICD為版本錯誤

如範例, D和E為ICD-9 code, 因此將與`ICD10DxwithTwoFormat`進行第二次的確認及轉換

D 結果不是NA, 表示D的ICD版本錯誤

E 結果為NA, 表示E的ICD編碼錯誤

**以範例`sampleDxFile`的warning message進行說明**
```
IcdDxShortToDecimal(sampleDxFile,ICD,Date,"2015/10/01")$ICD
#> Wrong ICD format: total 1 ICD codes (the number of occurrences is in brackets)
#> 123.45 (1)
#> 	
#> Wrong ICD version: total 4 ICD codes (the number of occurrences is in brackets)
#> c("A01.05 (1)", "E03.0 (1)", "A0105 (1)", "42761 (1)")
#> 	
#> Warning: The ICD mentioned above matches to "NA" due to the format or other issues.
#> Warning: "Wrong ICD format" means the ICD has wrong format
#> Warning: "Wrong ICD version" means the ICD classify to wrong ICD version (cause the "icd10usingDate" or other issues)
```
ICD編碼錯誤: 共一種ICD (括號內為該ICD出現次數) 

123.45 (1)

ICD版本錯誤: 共四種ICD (括號內為該ICD出現次數) 

c("A01.05 (1)", "E03.0 (1)", "A0105 (1)", "42761 (1)")

若想要看到全部的錯誤，可選擇list: Error，將顯示錯誤的ICD編碼、出現次數、在檔案中編碼被判斷為何種版本、錯誤的類別及建議該如何修正
```
IcdDxShortToDecimal(sampleDxFile,ICD,Date,"2015/10/01")$Error

#>       ICD count IcdVersionInFile     WrongType Suggestion
#> 1: 123.45     1           ICD 10  Wrong format           
#> 2: A01.05     1            ICD 9 Wrong version           
#> 3:  E03.0     1            ICD 9 Wrong version           
#> 4:  A0105     1            ICD 9 Wrong version           
#> 5:  42761     1           ICD 10 Wrong version 
```
## II. ICD-CM-code 標準化分組

將ICD診斷碼依國際標準轉換為有臨床意義的疾病分組功能，包括CCS階層式編碼轉換、PheWAS分群編碼、共病症（AHRQ, Charlson, Elixhauser Comorbidity）分組以及自定義診斷分組，可將分散的ICD-9-CM與ICD-10-CM基於臨床意義整合成較大的群組，以供後續分析使用。

目前四大類標準化分組方法: CCS, phecode, Comorbidity,以及自定義診斷碼分組, 以下將分別介紹之

經過四種標準化處理後, 可得兩種回傳的結果

1) **groupedDf**: 呈現方式如**表二**，將ICD診斷碼依國際標準轉換為有臨床意義的疾病分組, 可用來計算疾病世代 (condition era)

表二 標準化分組後回傳的資料型態

|Short|ID|ICD|Date|GroupType|
|----|--|-----|---|----|
|ICD short格式|病患編碼|使用者輸入的ICD格式 |診斷日期|標準化分組|

2) **groupedData_Long**: 呈現方式如**表三**，將同一個ID的病患其相同標準化分組的多筆資料會統整成一筆資料的長表，取診斷資料中最早診斷的時間為first case date，診斷資料中最後記錄的時間為end case date，並計算其週期（period）內相差的天數，以及週期內共有幾筆診斷紀錄（count）。 另可將其資料轉為適合進行統計分析之資料型態的寬表。長表資料型態如下

表三 標準化分組後回傳的長表資料型態

|ID|GroupType|(TimeTag)|FirstCaseDate|EndCaseDate|Count|Period|
|--|----|-----|---|---|---|-----|
|病患編碼|標準化分組|事件發生前/後|第一筆資料時間|最後一筆資料時間|個數|第一筆資料與最後一筆資料相隔週期|



###一、臨床分類軟體
美國Healthcare Cost and Utilization Project（HCUP）發展出一套診斷與處置的臨床分組標準Clinical Classifications Software（CCS），供資料分析人員參考。CCS將每個ICD-9-CM與ICD-10-CM編碼依照臨床意義作單層式或階層式的診斷分類。

基於此機制，分散的診斷碼可以以其臨床意義作進一步的整合。

單一階層: 較通用的分類

多階層: 將診斷碼分為較精確的分組

其階層式診斷分類可依使用需求調整分類標準

**1) CCS單一階層分類**

`IcdDxToCCS` 可取得 ICD-9-CM 及 ICD-10-CM 相對應的 CCS 分類(CCS Category)及分類之敘述

ICD-9-CM 和 ICD-10-CM 的ccs單一階層一致: 共260種
```
## ICD to CCS description
CCS_description <- IcdDxToCCS(sampleDxFile, ID, ICD, Date, "2015-10-01", TRUE)
head(CCS_description$groupedDf,5)
#>       Short ID    ICD       Date           CCS_CATEGORY_DESCRIPTION
#>   1:   5533  C  553.3 2008-04-03                   Abdominal hernia
#>   2:   5533  A  553.3 2008-05-01                   Abdominal hernia
#>   3:  55320  A 553.20 2009-02-23                   Abdominal hernia
#>   4:  55320  B 553.20 2007-08-29                   Abdominal hernia
#>   5:   5533  A  553.3 2008-06-27                   Abdominal hernia

head(CCS_description$groupedData_Long,5)
#>     ID   CCS_CATEGORY_DESCRIPTION  firstCaseDate endCaseDate count    period
#>  1:  C           Abdominal hernia     2008-04-03  2018-12-28     2 3921 days
#>  2:  A           Abdominal hernia     2008-05-01  2018-12-28     4 3893 days
#>  3:  B           Abdominal hernia     2007-08-29  2019-11-10     2 4456 days
#>  4:  B           Acute bronchitis     2008-04-29  2008-04-29     1    0 days
#>  5:  A           Acute bronchitis     2009-06-09  2009-06-09     1    0 days

## ICD to CCS category
CCS_category <- IcdDxToCCS(sampleDxFile, ID, ICD, Date, "2015-10-01", FALSE)
```

**2) CCS多階層分類**

`IcdDxToCCSLvl` 可取得 ICD-9-CM 及 ICD-10-CM 相對應的 CCS 多階層分類(Multiple ccs level)及分類之敘述

ICD-9-CM 共 4個階層 (Level 1~4)

ICD-10-CM 共 2個階層 (Level 1~2)
```
## ICD to CCS multiple level 2 description
CCSlvl_description <- IcdDxToCCSLvl(sampleDxFile, ID, ICD, Date, "2015-10-01",2, TRUE)
head(CCSlvl_description$groupedDf,5)
#>       Short ID    ICD       Date      CCS_LVL_2_LABEL
#>   1:   5533  C  553.3 2008-04-03     Abdominal hernia
#>   2:   5533  A  553.3 2008-05-01     Abdominal hernia
#>   3:  55320  A 553.20 2009-02-23     Abdominal hernia
#>   4:  55320  B 553.20 2007-08-29     Abdominal hernia
#>   5:   5533  A  553.3 2008-06-27     Abdominal hernia

head(CCSlvl_description$groupedData_Long,5)
#>     ID                                       CCS_LVL_2_LABEL firstCaseDate endCaseDate count     period
#>  1:  C                                      Abdominal hernia    2008-04-03  2018-12-28     2  3921 days
#>  2:  A                                      Abdominal hernia    2008-05-01  2018-12-28     4  3893 days
#>  3:  B                                      Abdominal hernia    2007-08-29  2019-11-10     2  4456 days
#>  4:  B                                Respiratory infections    2008-04-29  2008-04-29     1     0 days
#>  5:  A                                Respiratory infections    2009-06-09  2009-06-09     1     0 days

## ICD to CCS multiple level 3 category
CCSLvl_category <- IcdDxToCCSLvl(sampleDxFile, ID, ICD, Date, "2015-10-01",3, FALSE)
```
###二、Phecode
由 Vanderbilt University Medical Center 開發的 PheWAS 工具, PheWAS套件使用自訂的phecode定義ICD-9-CM code的編碼分組，約一萬多筆的ICD-9-CM code診斷碼分為共1,866種較大的phecode分類，ICD-9-CM和phecode為多對多的配對關係。

最新版本為 version 2 (phecode_icd9_2), 目前只有 ICD-9-CM 供轉換分類
```
## ICD to Phecode
phecode <- IcdDxToPhecode(sampleDxFile, ID, ICD, Date, "2015-10-01", FALSE)
head(phecode$groupedDf,5)
#>        ICDD ID    ICD       Date PheCode
#>   1:  553.3  C  553.3 2008-04-03   550.2
#>   2:  553.3  A  553.3 2008-05-01   550.2
#>   3: 553.20  A 553.20 2009-02-23   550.5
#>   4: 553.20  B 553.20 2007-08-29   550.5
#>   5:  553.3  A  553.3 2008-06-27   550.2
head(phecode$groupedData_Long,5)
#>     ID PheCode firstCaseDate endCaseDate count   period
#>  1:  C   550.2    2008-04-03  2008-04-03     1   0 days
#>  2:  A   550.2    2008-05-01  2008-06-27     2  57 days
#>  3:  A   550.5    2009-02-23  2009-02-23     1   0 days
#>  4:  B   550.5    2007-08-29  2007-08-29     1   0 days
#>  5:  B     483    2008-04-29  2008-04-29     1   0 days

```

###三、自定義診斷碼分組

因應臨床研究需求，emr提供進階使用者自行定義診斷分組類別及類別項目，使用者可選擇窮舉法或是以字串比對方式訂定篩選的分組類別及類別項目進行後續的分群，本套件採多樣的分組方式以維持診斷醫療大數據分析的彈性。

範例如下，若使用者欲找出符合心律異常（Cardiac dysrhythmias）案例，使用ICD-10編碼為I47.* ~ I49.* 及 ICD-9-CM編碼為427.*

根據上述定義，本套件可輸出符合定義之診斷紀錄。自定義診斷分組提供兩種分組方法供使用者選擇，找出符合條件的ICD。




**1) IcdDxToCustom** 使用**窮舉法**的方式找出符合的ICD

使用者欲找出歸類為Cardiac dysrhythmias的診斷碼，需要輸入所有想要尋找的ICD完整編碼（427.1, 427.2, 42761…），進行比對的資料須要完全符合才會歸類為Cardiac dysrhythmias


符合條件使用者定義之Cardiac dysrhythmias分組（groupingTable），另外不符合條件的紀錄則顯示`NA`。

```{r}
# groupingTable 
groupingTable <- data.frame(group = rep("Cardiac dysrhythmias",6),
                            ICD = c("427.1","427.2","427.31","427.61","427.81","427.89"),
                            stringsAsFactors = FALSE)
```
```
CustomGroup <- IcdDxToCustom(sampleDxFile, ID, ICD, Date, CustomGroupingTable = groupingTable)
CustomGroup$groupedDf[10:15]
#>     ICD   ID       Date                group
#> 1:  466.0  A 2009-06-09                 <NA>
#> 2: 427.61  A 2009-02-16 Cardiac dysrhythmias
#> 3: 427.31  C 2007-06-20 Cardiac dysrhythmias
#> 4: 427.89  C 2008-01-23 Cardiac dysrhythmias
#> 5: 427.31  A 2007-09-19 Cardiac dysrhythmias
#> 6: 427.31  C 2008-09-11 Cardiac dysrhythmias
CustomGroup$groupedData_Long
#>    ID                group firstCaseDate endCaseDate count   period
#> 1:  A Cardiac dysrhythmias    2007-07-27  2009-02-16     4 570 days
#> 2:  C Cardiac dysrhythmias    2007-06-20  2009-02-08     9 599 days
#> 3:  B Cardiac dysrhythmias    2007-07-16  2009-02-25     5 590 days
```
**2) IcdDxToCustomGrep** 選擇**字串比對**進行篩選

使用字串比對的方式，使用者輸入想要尋找的ICD編碼字串比對之正規表示式（427* , I47 * …），進行局部的比對，當資料開頭為427* （ICD-9-CM）或是I47 *（ICD-10-CM）即符合使用者定義之條件Cardiac dysrhythmias分組。



符合條件使用者定義之Cardiac dysrhythmias分組（groupingTable），另外不符合條件的紀錄則顯示空值。

```{r}
# grepTable
grepTable <- data.frame(group = "Cardiac dysrhythmias",
                        grepIcd = "^427|^I48",
                        stringsAsFactors = FALSE)
```
```
CustomGrepGroup <- IcdDxToCustomGrep(sampleDxFile, ID, ICD, Date,CustomGroupingTable = grepTable)
CustomGrepGroup$groupedDf[10:15]
#>    ID    ICD       Date                group
#> 1:  A  466.0 2009-06-09                     
#> 2:  A 427.61 2009-02-16 Cardiac dysrhythmias
#> 3:  C 427.31 2007-06-20 Cardiac dysrhythmias
#> 4:  C 427.89 2008-01-23 Cardiac dysrhythmias
#> 5:  A 427.31 2007-09-19 Cardiac dysrhythmias
#> 6:  C 427.31 2008-09-11 Cardiac dysrhythmias

CustomGrepGroup$groupedData_Long
#>    ID                group firstCaseDate endCaseDate count    period
#> 1:  A Cardiac dysrhythmias    2007-07-27  2021-12-13    10 5253 days
#> 2:  C Cardiac dysrhythmias    2007-06-20  2021-09-16    16 5202 days
#> 3:  B Cardiac dysrhythmias    2007-07-16  2020-10-11    10 4836 days
```
###四、共病症
Elixhauser Comorbidity為Dr. Elixhauser與其團隊在1998年提出基於標準ICD診斷碼的共病症分類分組標準，於2017年基於Elixhauser Comorbidity 更進一步設計AHRQ Elixhauser Comorbidity Index，此index為單一的風險評估分數，可用於再入院與死亡的風險評估，有研究指出AHRQ Elixhauser Comorbidity Index比Charlson Index更能預測骨科手術的術後死亡。

共病症(Comorbidities)為病患於主診斷之外, 其他已存在且會對主診斷疾病產生影響的疾病症狀

共病症分群基於ICD診斷碼進行標準化分組, 根據不同測量方法對共病症的定義分別介紹之: AHRQ, Charlson及Elixhauser

**1) AHRQ**

AHRQ database共病症測量指標是基於Elixhauser共病症測量指標, 使ICD code 依其相關的共病症做分類

ICD-9-CM及 ICD-10-CM的AHRQ 共病症種類一致, 共30種

 ICD-9
```
# convert icd9_map_ahrq (list) to icd9_ahrq (data frame)
icd9_ahrq$Comorbidity %>% unique
```
 ICD-10
```
# convert icd10_map_ahrq (list) to icd10_ahrq (data frame)
icd10_ahrq$Comorbidity %>% unique
```
欲將 ICD 依照 AHRQ 共病症分類, 在 function `IcdDxToComorbid` 的 `comorbidMethod` 輸入 `AHRQ`

```
AHRQ <- IcdDxToComorbid(sampleDxFile, ID, ICD, Date, "2015-10-01", ahrq)
AHRQ$groupedDf[160:164]
#>    Short ID    ICD       Date Comorbidity
#> 1: K7460  C K74.60 2021-01-09       Liver
#> 2:  Z720  A  Z72.0 2020-04-29        <NA>
#> 3: G2581  B G25.81 2021-06-24  NeuroOther
#> 4: Z6832  C Z68.32 2019-10-16     Obesity
#> 5: 42761  A  42761 2020-03-16        <NA>

head(AHRQ$groupedData_Long,5)
#>    ID Comorbidity firstCaseDate endCaseDate count    period
#> 1:  A       Renal    2007-05-12  2019-08-15    31 4478 days
#> 2:  C       Renal    2007-04-21  2021-09-17    31 5263 days
#> 3:  B       Renal    2007-05-28  2022-03-18    33 5408 days
#> 4:  C       Liver    2021-01-09  2021-01-09     1    0 days
#> 5:  B  NeuroOther    2021-06-24  2021-06-24     1    0 days

```
**2) Charlson**

Charlson database共病症測量指標的是基於Halfon和 Quan's的版本, 使 ICD code 依其相關的共病症做分類

ICD-9-CM 及 ICD-10-CM 的 Charlson 共病症種類一致, 共17種

 ICD-9
```
# convert icd9_map_charlson (list) to icd9_charlson (data frame)
icd9_charlson$Comorbidity %>% unique
```
 ICD-10
```
# convert icd10_map_charlson (list) to icd10_charlson (data frame)
icd10_charlson$Comorbidity %>% unique
```
欲將 ICD 依照 Charlson 共病症分類, 在 function `IcdDxToComorbid` 的`comorbidMethod` 輸入 `Charlson`

```
Charlson <- IcdDxToComorbid(sampleDxFile, ID, ICD, Date, "2015-10-01", charlson)
Charlson$groupedDf[160:164]
#>    Short ID    ICD       Date Comorbidity
#> 1: K7460  C K74.60 2021-01-09   LiverMild
#> 2:  Z720  A  Z72.0 2020-04-29        <NA>
#> 3: G2581  B G25.81 2021-06-24        <NA>
#> 4: Z6832  C Z68.32 2019-10-16        <NA>
#> 5: 42761  A  42761 2020-03-16        <NA>

head(Charlson$groupedData_Long,5)
#>    ID Comorbidity firstCaseDate endCaseDate count    period
#> 1:  A       Renal    2007-05-12  2022-02-08    33 5386 days
#> 2:  C       Renal    2007-04-21  2021-09-17    33 5263 days
#> 3:  B       Renal    2007-05-28  2022-03-18    34 5408 days
#> 4:  C   LiverMild    2021-01-09  2021-01-09     1    0 days
```
**3) Elixhauser**

Elixhauser database共病症測量指標為HCUP (Healthcare Cost and Utilization Project)發展的共病症資料庫之一, 使 ICD code 依其相關的共病症做分類

ICD-9-CM 及 ICD-10-CM 的 Elixhauser 共病症種類一致, 共 29 種

 ICD-9-Elixhauser: 
```
icd9_elix$Comorbidity %>% unique
```
 ICD-10-Elixhauser: 
```
icd10_elix$Comorbidity %>% unique
```
欲將 ICD 依照 Charlson 共病症分類, 在 function `IcdDxToComorbid` 的`comorbidMethod` 輸入 `elix`
```
ELIX <- IcdDxToComorbid(sampleDxFile, ID, ICD, Date, "2015-10-01", elix)
ELIX$groupedDf[160:164]
#>    Short ID    ICD       Date Comorbidity
#> 1: K7460  C K74.60 2021-01-09     HYPOTHY
#> 2:  Z720  A  Z72.0 2020-04-29        <NA>
#> 3: G2581  B G25.81 2021-06-24        METS
#> 4: Z6832  C Z68.32 2019-10-16       NEURO
#> 5: 42761  A  42761 2020-03-16        <NA>

head(ELIX$groupedData_Long,5)
#>     ID Comorbidity firstCaseDate endCaseDate count    period
#>  1:  A    RENLFAIL    2007-05-12  2009-04-26    28  715 days
#>  2:  C    RENLFAIL    2007-04-21  2021-09-17    29 5263 days
#>  3:  B    RENLFAIL    2007-05-28  2022-03-03    29 5393 days
#>  4:  B    PULMCIRC    2019-03-11  2022-03-18     4 1103 days
#>  5:  C    PULMCIRC    2019-12-28  2020-05-10     2  134 days
```
## III. 篩選符合條件的個案
將醫療大數據診斷資訊進行標準化處理與整合後，將依據使用者所設立的條件篩選符合條件的資料。為選取符合特定條件之診斷資料，目前有三種條件進行篩選：

1) 	設定一組ICD（窮舉法）或正規表示式字串比對語法（785.*） 
2) 	設定搜尋範圍：預設範圍時間為至少間隔一個月至一年時間內的資料
3) 	ICD次數：限制符合前述條件的ICD須至少出現的次數，預設至少出現兩次

最後回傳符合條件的個案資料如**表四**。

表四 選取特定個案診斷紀錄後回傳的資料型態

|ID|FirstCaseDate|EndCaseDate|Period|Count|MostCommonICD|MostCommonICDCount|
|--|---|---|--|--|-----|-----|
|病患編碼|第一筆資料時間|最後一筆資料時間|第一筆資料與最後一筆資料相隔週期|個數| | |


符合條件的個案將整合為一筆資料，內容包含符合條件的資料總數（count），第一筆資料（first case date）及最後一筆資料時間（end case date）及資料時間相隔週期（period），出現最多次的ICD及次數（most common ICD and most common ICD count）。

篩選個案的功能和疾病世代的概念類似，適用於一般疾病（限制搜尋範圍）或慢性病（沒有限制搜尋範圍）的計算。

```
selectCases("^785", sampleDxFile, ID, ICD, Date, 2)
#>    ID firstCaseDate endCaseDate count   period MostCommonICD MostCommonICDCount
#> 1:  A    2008-05-03  2009-03-02     3 303 days         785.1                  2
#> 2:  B    2008-01-19  2008-04-07     3  79 days         785.1                  2
```
## IV. 以事件區分指標日期（index date）區分事件前後的醫療紀錄
醫學研究常需要觀察事件發生前後的改變，因此需要一個指標時間（index date）來記錄事件的發生，在使用指標時間切割後，TimeTag欄位可顯示此紀錄為事件前或是事件後（before and after），使用者可依此欄位選擇事件發生前／後的資料。

另外本套見也提供週期（window）計算功能，週期長度和指標日期由使用者自行設立。

```
splitDataByDate(sampleDxFile, ID, ICD, Date,"2015-10-01",30)
#>      ID    ICD       Date timeTag Window
#>   1:  C  553.3 2008-04-03       B     92
#>   2:  A  553.3 2008-05-01       B     91
#>   3:  A 553.20 2009-02-23       B     81
#>   4:  B 553.20 2007-08-29       B     99
#>   5:  A  553.3 2008-06-27       B     89
```
## V. 寬表
診斷碼整合分組後，為能進行後續的醫學統計分析，須將分組後的長表資料型態轉為適合進行統計分析之資料型態的寬表。

寬表共兩種表示方式如**表五、表六**，以二分法（binary）或是數量（numeric）的方式呈現。當病患沒有相關的疾病診斷，二分法的表示法為false，反之，不論有幾筆疾病診斷紀錄，二分法的表示法為true。數量表示法則計算該病患在相關疾病的分組上有幾筆疾病診斷資料

以下範例以CCS 多階層為範例進行兩種表示法進行回傳資料型態的示範
```
groupedDataLongToWide(sampleDxFile, ID, ICD, Date, "2015-10-01", ccs,numericOrBinary = B)
```
表五 標準化分組結果轉為二分法（binary）寬表

|ID|Abdominal hernia|Acute bronchitis|Cardiac dysrhythmias |	….. (共136種)|
|--|---|------|---|-------|
|A|true|true|true| …..|	
|B|true|true|true|	…..|
|C|true|false|true|	…..|
```
groupedDataLongToWide(sampleDxFile, ID, ICD, Date, "2015-10-01", ccs,numericOrBinary = N)
```
表六 標準化分組結果轉為數量（numeric）寬表

|ID|Abdominal hernia|Acute bronchitis|Cardiac dysrhythmias |	….. (共136種)|
|--|---|------|---|-------|
|A|4|1|12| …..|	
|B|2|1|13|	…..|
|C|2|0|19|	…..|

## VI. 疾病世代
在診斷紀錄整合機制方面，本計畫針對分散的診斷紀錄使用Dr. Ryan提出疾病世代（Condition era）概念整合處理連續性的醫療行為，將分散的醫療紀錄整合為單一病程發展紀錄，以利後續醫療大數據分析使用。

疾病世代的概念是針對疾病定義持續期（gap）長度，若診斷與診斷間間隔小於gap，則兩個診斷視為同一個疾病世代。

疾病世代的診斷分類可依據ICD、CCS、Phecode、comorbidity和自定義分類組別，計算病患之疾病世代，其持續期長度預設值為30天。
```
getConditionEra(sampleDxFile, ID, ICD, Date, "2016-01-01", 30, ccs, FALSE)
#>     ID CCS_CATEGORY firstCaseDate endCaseDate count Era    period
#>  1:  C          158    2007-04-21  2021-09-17    33  16 5263 days
#>  2:  B          158    2007-05-28  2022-03-18    34  14 5408 days
#>  3:  C          106    2007-06-20  2021-09-16    19  14 5202 days
#>  4:  A          158    2007-05-12  2022-02-08    33  12 5386 days
#>  5:  B          106    2007-07-16  2020-10-11    13  10 4836 days

grepTable <- data.frame(group = "Cardiac dysrhythmias",
                        grepIcd = "^427|^I48",
                        stringsAsFactors = FALSE)
getConditionEra(sampleDxFile, ID, ICD, Date, "2015-10-01", 30, customGrepIcdGroup, CustomGroupingTable = grepTable)
#>    ID                group firstCaseDate endCaseDate count Era    period
#> 1:  C Cardiac dysrhythmias    2007-06-20  2021-09-16    16  12 5202 days
#> 2:  A Cardiac dysrhythmias    2007-07-27  2021-12-13    10   9 5253 days
#> 3:  B Cardiac dysrhythmias    2007-07-16  2020-10-11    10   9 4836 days
```
## VII. 參考資料

本套件使用之CCS版本依照HCUP提供之最新版本進行年度的更新，目前ICD-9-CM與ICD-10-CM的CCS定義版本分別為2015年及2019年版。

Phecode依照PheWAS Resources網站 進行更新，目前版本為第二版（2015年）。

Elixhauser共病症依照HCUP提供之版本進行更新，目前ICD-9-CM與ICD-10的Elixhauser共病症定義版本分別為2015年及2019年版。


### ICD 格式: Short 和 Decimal

ICD-9-CM code (2014): https://www.cms.gov/Medicare/Coding/ICD9ProviderDiagnosticCodes/codes.html

ICD-10-CM code (2019): https://www.cms.gov/Medicare/Coding/ICD10/2019-ICD-10-CM.html

https://www.cms.gov/Medicare/Coding/ICD10/2019-ICD-10-CM.html

https://www.findacode.com/search/search.php

https://www.cms.gov/Medicare/Quality-Initiatives-Patient-Assessment-Instruments/HospitalQualityInits/Downloads/HospitalAppendix_F.pdf

### ICD 格式轉換功能 (`IcdDxDecimaltoShort 和 IcdDxShortToDecimal`)

https://www.findacode.com/search/search.php

https://www.cms.gov/Medicare/Quality-Initiatives-Patient-Assessment-Instruments/HospitalQualityInits/Downloads/HospitalAppendix_F.pdf

### 臨床分類軟體 (Clinical Classifications Software, CCS)

ICD-9-CM (2015): https://www.hcup-us.ahrq.gov/toolssoftware/ccs/Single_Level_CCS_2015.zip

https://www.hcup-us.ahrq.gov/toolssoftware/ccs/Multi_Level_CCS_2015.zip

ICD-10-CM (2019): https://www.hcup-us.ahrq.gov/toolssoftware/ccs10/ccs_dx_icd10cm_2019_1.zip

### Phecode

ICD-9-Phecode (version 1.2, 2015): https://phewascatalog.org/phecodes

### Comorbidities 共病症

#### AHRQ

ICD-9-AHRQ (2012-2015): https://www.hcup-us.ahrq.gov/toolssoftware/comorbidity/comorbidity.jsp#references

ICD-10-AHRQ (2019): https://www.hcup-us.ahrq.gov/toolssoftware/comorbidityicd10/comformat_icd10cm_2019_1.txt

#### Charlson

ICD-9-Charlson: http://mchp-appserv.cpe.umanitoba.ca/Upload/SAS/ICD9_E_Charlson.sas.txt

ICD-10-Charlson: http://mchp-appserv.cpe.umanitoba.ca/Upload/SAS/ICD10_Charlson.sas.txt


#### Elixhauser

ICD-9-Elixhauser  ver:3.7 (2012-2015): https://www.hcup-us.ahrq.gov/toolssoftware/comorbidity/comorbidity.jsp#references

ICD-10-Elixhauser ver: 2019.1 (2019): https://www.hcup-us.ahrq.gov/toolssoftware/comorbidityicd10/comformat_icd10cm_2019_1.txt
